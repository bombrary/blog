<!DOCTYPE html>
<html lang="ja-jp">
<title>PureScriptで作るBrainfuckインタプリタ 4/4 Halogenの利用 | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.106.0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/index.css">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/purescript-brainfuck04/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
  <link rel="stylesheet" href="/blog/css/custom.css">

  <link rel="stylesheet" href="/blog/css/syntax.css">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>




<header>
  
    <a href="https://bombrary.github.io/blog/" class="title">Chanomic Blog</a>
  
  
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/purescript-brainfuck04/">PureScriptで作るBrainfuckインタプリタ 4/4 Halogenの利用</a></h1>
    <div class="meta">
      
      <div class="pub-date">
        <time datetime="2021-07-09T23:15:00&#43;09:00">July 09, 2021</time>
      </div>
      
      
      <div class="lastmod-date">
        <div class="lastmod-date__label">(last modified:</div>
        <time datetime="2021-07-09T23:15:00&#43;09:00">July 09, 2021</time>
        <div class="lastmod-date__label">)</div>
      </div>
      
    </div>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/halogen/">Halogen</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="categories_item"><a href="https://bombrary.github.io/blog//categories/purescript/">PureScript</a></li> <li class="categories_item"><a href="https://bombrary.github.io/blog//categories/brainfuck/">Brainfuck</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  
    <aside>
      <h2>目次</h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#halogenの利用">Halogenの利用</a>
      <ul>
        <li><a href="#雛形">雛形</a></li>
      </ul>
    </li>
    <li><a href="#仕様">仕様</a></li>
    <li><a href="#プログラム入力エリアと実行結果エリアの作成">プログラム入力エリアと実行結果エリアの作成</a>
      <ul>
        <li><a href="#stateの追加">Stateの追加</a></li>
        <li><a href="#実行中は実行ボタンが押せないようにする">実行中は実行ボタンが押せないようにする</a></li>
      </ul>
    </li>
    <li><a href="#出力エリアの作成">出力エリアの作成</a>
      <ul>
        <li><a href="#staterenderの追加">State、renderの追加</a></li>
        <li><a href="#actionの追加">Actionの追加</a></li>
        <li><a href="#streamの作成">Streamの作成</a></li>
      </ul>
    </li>
    <li><a href="#入力エリアの作成">入力エリアの作成</a>
      <ul>
        <li><a href="#stateの追加-1">Stateの追加</a></li>
        <li><a href="#actionの追加-1">Actionの追加</a></li>
        <li><a href="#renderの実装">renderの実装</a></li>
      </ul>
    </li>
    <li><a href="#プログラムの実行中の様子を可視化する">プログラムの実行中の様子を可視化する</a>
      <ul>
        <li><a href="#stateの定義">Stateの定義</a></li>
        <li><a href="#logの定義">Logの定義</a></li>
        <li><a href="#actionの定義">Actionの定義</a></li>
        <li><a href="#viewの定義">Viewの定義</a></li>
      </ul>
    </li>
    <li><a href="#ソースコードとデモ">ソースコードとデモ</a></li>
    <li><a href="#感想とまとめ">感想とまとめ</a>
      <ul>
        <li><a href="#brainfuckの思い出">Brainfuckの思い出</a></li>
        <li><a href="#まとめ">まとめ</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </aside>
    
  <h2 id="halogenの利用">Halogenの利用</h2>
<p>続いて、GUIでBrainfuckを動かすことをやってみる。
GUIのフレームワークとして、ここでは<a href="https://pursuit.purescript.org/packages/purescript-halogen/6.1.2">purescript-halogen</a>を使ってみる。
Halogenについてはまだ勉強中で、この記事は解説記事というより勉強記録である(いままでの記事もそうではあるのだが)。</p>
<pre class="cui">
% spago install halogen
</pre>

<h3 id="雛形">雛形</h3>
<p><code>src/Main.purs</code>を以下のようにする。
ここのコードはほとんど<a href="https://github.com/purescript-halogen/purescript-halogen/tree/master/docs/guide">Halogen Guide</a>と同様。
関数名的におそらく、<code>body</code>要素を取得して、その中で<code>component</code>を走らせるのだと思う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Prelude</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect</span> <span class="p">(</span><span class="kt">Effect</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.Aff</span> <span class="p">(</span><span class="nf">awaitBody</span><span class="p">,</span> <span class="nf">runHalogenAff</span><span class="p">)</span> <span class="n">as</span> <span class="kt">HA</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.VDom.Driver</span> <span class="p">(</span><span class="nf">runUI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Component</span> <span class="p">(</span><span class="nf">component</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="ow">::</span> <span class="kt">Effect</span> <span class="kt">Unit</span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="ow">=</span> <span class="kt">HA</span><span class="o">.</span><span class="n">runHalogenAff</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">body</span> <span class="ow">&lt;-</span> <span class="kt">HA</span><span class="o">.</span><span class="n">awaitBody</span>
</span></span><span class="line"><span class="cl">  <span class="n">runUI</span> <span class="n">component</span> <span class="n">unit</span> <span class="n">body</span>
</span></span></code></pre></div><p><code>component</code>は<code>src/Component.purs</code>で定義する。とりあえず雛形を作成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Component</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Prelude</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen</span> <span class="k">as</span> <span class="n">H</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.HTML</span> <span class="k">as</span> <span class="n">HH</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl">  <span class="ow">=</span> <span class="kt">Dummy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">input</span><span class="o">.</span> <span class="n">input</span> <span class="ow">-&gt;</span> <span class="kt">State</span>
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="kr">_</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">component</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">query</span> <span class="n">input</span> <span class="n">output</span> <span class="n">m</span><span class="o">.</span> <span class="kt">H</span><span class="o">.</span><span class="kt">Component</span> <span class="n">query</span> <span class="n">input</span> <span class="n">output</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl"><span class="nf">component</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">H</span><span class="o">.</span><span class="n">mkComponent</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">initialState</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">render</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">eval</span><span class="kt">:</span> <span class="kt">H</span><span class="o">.</span><span class="n">mkEval</span> <span class="o">$</span> <span class="kt">H</span><span class="o">.</span><span class="n">defaultEval</span> <span class="p">{</span> <span class="n">handleAction</span> <span class="ow">=</span> <span class="n">handleAction</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">render</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">m</span><span class="o">.</span> <span class="kt">State</span> <span class="ow">-&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">ComponentHTML</span> <span class="kt">Action</span> <span class="nb">()</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">p_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="s">&#34;Hello&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">output</span> <span class="n">m</span><span class="o">.</span> <span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">HalogenM</span> <span class="kt">State</span> <span class="kt">Action</span> <span class="nb">()</span> <span class="n">output</span> <span class="n">m</span> <span class="kt">Unit</span>
</span></span><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Dummy</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="n">unit</span>
</span></span></code></pre></div><p><a href="https://github.com/purescript-halogen/purescript-halogen/blob/master/docs/guide/02-Introducing-Components.md">Halogen Guide 02</a>の2段落目によると、Componentとは、
「入力を受け付けて、HTMLを生成するもの」のこと。さらにComponentは内部状態を持っている。そして何かイベントを定義することができ、それに応じて内部状態を変えたり、副作用を起こしたりできる。</p>
<p>Halogenにおいて、状態は <em>State</em>、イベントは <em>Action</em>、と呼ばれる。<code>render</code>でHTMLを生成することができる。<code>handleAction</code>で Action を補足し、何かしらの処理を行うことができる。
Elmとの比較でいうと、State が Model、Action が Msg、render が view、handleAction が update に当たる。</p>
<p>何やら各関数の型がごついので、これについて一応補足しておく。
型変数<code>query</code>、<code>output</code>に関しては、複数のコンポーネントを作った場合にそれら同士のやりとりで使うようだが、今回は必要ないため、型変数のままにしておく。
<code>H.ComponentHTML Action () m</code>の<code>()</code>についても同様に、複数コンポーネントを扱う場合に関わってくるものなので、今回は必要ない。
<code>input</code>は、コンポーネントの状態を初期化するときに指定する引数の型。これは入力エリア作成のときに利用する。
<code>m</code>はモナドで、<code>handleAction</code>で副作用を扱うときに必要となる。
後で<code>Aff</code>関係の処理を書きたいときに、<code>MonadAff m</code>の型クラス制約を追加する (実際は、<a href="https://pursuit.purescript.org/packages/purescript-halogen/6.1.2/docs/Halogen.VDom.Driver#v:runUI">runUI</a>のときに<code>m</code>は<code>Aff</code>に推論される)。</p>
<p>この時点で<code>bundle-app</code>してみる。</p>
<pre class="cui">
% spago bundle-app -t dist/Main.js
</pre>

<p><code>dist/</code>にて以下のhtmlファイルを作って開くと、<code>Hello</code>とだけ表示される。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="o">&lt;!</span><span class="kt">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="ow">=</span><span class="s">&#34;utf-8&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="ow">=</span><span class="s">&#34;Main.js&#34;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</span></span></code></pre></div><h2 id="仕様">仕様</h2>
<ol>
<li>プログラム入力エリアにプログラムを入力し、実行ボタンを押すとプログラムが実行される</li>
<li>実行結果と実行後の<code>iptr</code>、<code>dptr</code>、<code>memory</code>を表示する。</li>
<li>実行時に出力命令を踏んだときに、出力エリアに文字が表示される。</li>
<li>実行時に入力命令を踏んだときに、入力エリアが出現。それまでプログラムは停止し、入力を確定すると再開する。</li>
</ol>
<p>1と2は簡単。3は<code>Brainfuck.State.State</code>の内部状態をダンプする関数を実装すれば良いだけなので、難しくない。
4は<a href="https://github.com/purescript-halogen/purescript-halogen/blob/master/docs/guide/04-Lifecycles-Subscriptions.md#subscriptions">Halogen GuideのSubscriptionの項</a>を読むとできる。</p>
<p>5が結構悩ましく、2つの方法が思いついた。</p>
<ul>
<li><code>interpProgram</code>や<code>interpCommand</code>を使わず、<code>handleAction</code>の中で<code>Interp</code>を逐次評価する。すると入力処理は<code>Action</code>の中で自然に扱える。</li>
<li><a href="https://pursuit.purescript.org/packages/purescript-avar/4.0.0">avar</a>を使い、BrainfuckインタプリタとComponent間でデータのやりとりをする。</li>
</ul>
<p>後者が実装が楽なのでこれを用いる。</p>
<h2 id="プログラム入力エリアと実行結果エリアの作成">プログラム入力エリアと実行結果エリアの作成</h2>
<h3 id="stateの追加">Stateの追加</h3>
<p><code>src/Component.purs</code>に戻る。以下のインポート文を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span> <span class="n">as</span> <span class="kt">B</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Interp.Stream</span> <span class="p">(</span><span class="nf">defaultStream</span><span class="p">)</span> <span class="n">as</span> <span class="kt">BIS</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Interp.Log</span> <span class="p">(</span><span class="nf">noLog</span><span class="p">)</span> <span class="n">as</span> <span class="kt">BIL</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.State</span> <span class="p">(</span><span class="kt">State</span><span class="p">(</span><span class="o">..</span><span class="p">))</span> <span class="n">as</span> <span class="kt">BS</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Interp</span> <span class="p">(</span><span class="kt">InterpResult</span><span class="p">)</span> <span class="n">as</span> <span class="kt">BI</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Program</span> <span class="p">(</span><span class="nf">fromString</span><span class="p">)</span> <span class="n">as</span> <span class="kt">BP</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Maybe</span> <span class="p">(</span><span class="kt">Maybe</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Either</span> <span class="p">(</span><span class="kt">Either</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff.Class</span> <span class="p">(</span><span class="nf">class</span> <span class="kt">MonadAff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Class</span> <span class="p">(</span><span class="nf">liftEffect</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.HTML.Events</span> <span class="k">as</span> <span class="n">HE</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.HTML.Properties</span> <span class="k">as</span> <span class="n">HP</span>
</span></span></code></pre></div><p>状態を決める。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">program</span> <span class="ow">::</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">result</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">BI</span><span class="o">.</span><span class="kt">InterpResult</span> <span class="kt">Unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">input</span><span class="o">.</span> <span class="n">input</span> <span class="ow">-&gt;</span> <span class="kt">State</span>
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="kr">_</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">program</span><span class="kt">:</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">result</span><span class="kt">:</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>次の<code>Action</code>を定義する。</p>
<ul>
<li><code>ChangeProgram</code>: プログラム入力エリアが変更された場合に起こる。</li>
<li><code>ExecuteProgram</code>: プログラム実行ボタンが押されたときに起こる。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl">  <span class="ow">=</span> <span class="kt">ChangeProgram</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">ExecuteProgram</span>
</span></span></code></pre></div><p>Viewは次のようにする。プログラム入力エリア、実行ボタン、実行結果を表示する。
入力が変化したとき、クリックされたときはそれぞれ<code>HE.onValueChange</code>、<code>HE.onClick</code>で補足できる。
関数の引数に、起こる<code>Action</code>を指定する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">render</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">m</span><span class="o">.</span> <span class="kt">State</span> <span class="ow">-&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">ComponentHTML</span> <span class="kt">Action</span> <span class="nb">()</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="n">programArea</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kr">case</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">        <span class="kt">Just</span> <span class="n">res</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">interpResult</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">programArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span><span class="o">.</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl"><span class="nf">programArea</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">textarea</span> <span class="p">[</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onValueChange</span> <span class="kt">ChangeProgram</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">button</span> <span class="p">[</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onClick</span> <span class="p">(</span><span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">ExecuteProgram</span><span class="p">)</span> <span class="p">]</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="s">&#34;Execute&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">interpResult</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span> <span class="n">i</span><span class="o">.</span> <span class="kt">BI</span><span class="o">.</span><span class="kt">InterpResult</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="nf">interpResult</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">state</span> <span class="p">}</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="p">{</span> <span class="n">iptr</span><span class="p">,</span> <span class="n">dptr</span><span class="p">,</span> <span class="n">memory</span> <span class="p">}</span> <span class="ow">=</span> <span class="kt">BS</span><span class="o">.</span><span class="n">dump</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">      <span class="n">message</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">        <span class="kr">case</span> <span class="n">result</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">          <span class="kt">Right</span> <span class="kr">_</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Succeed&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kt">Left</span> <span class="n">err</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">show</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">in</span>
</span></span><span class="line"><span class="cl">    <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="s">&#34;Result: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">message</span><span class="p">)</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">          <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">ul_</span>
</span></span><span class="line"><span class="cl">              <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">li_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="s">&#34;iptr: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">iptr</span><span class="p">)</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">li_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="s">&#34;dptr: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">dptr</span><span class="p">)</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">li_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="s">&#34;memory: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">memory</span><span class="p">)</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span></code></pre></div><p><code>handleAction</code>を実装。<code>liftAff</code>を使う都合上、<code>MonadAff</code>の型クラス制約を加える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">output</span> <span class="n">m</span><span class="o">.</span> <span class="kt">MonadAff</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">HalogenM</span> <span class="kt">State</span> <span class="kt">Action</span> <span class="nb">()</span> <span class="n">output</span> <span class="n">m</span> <span class="kt">Unit</span>
</span></span><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ChangeProgram</span> <span class="n">program</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">program</span> <span class="ow">=</span> <span class="n">program</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ExecuteProgram</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">program</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">B</span><span class="o">.</span><span class="n">run</span> <span class="kt">BIS</span><span class="o">.</span><span class="n">defaultStream</span> <span class="kt">BIL</span><span class="o">.</span><span class="n">noLog</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="n">fromString</span> <span class="n">program</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="n">res</span> <span class="p">}</span>
</span></span></code></pre></div><p><code>component</code>にも<code>MonadAff</code>を加える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">component</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">query</span> <span class="n">input</span> <span class="n">output</span> <span class="n">m</span><span class="o">.</span> <span class="kt">MonadAff</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">Component</span> <span class="n">query</span> <span class="n">input</span> <span class="n">output</span> <span class="n">m</span>
</span></span></code></pre></div><p><code>bundle-app</code>すると以下のようにテキストエリアとボタンが出現し、テキストエリアにBrainfuckプログラムを入力してExecuteボタンを押すと、実行結果が下に出力される。
本当はCSSをいじって見栄えをよくしたいが、今回はやらない。</p>
<figure><img src="img00.png" width="70%"/>
</figure>

<h3 id="実行中は実行ボタンが押せないようにする">実行中は実行ボタンが押せないようにする</h3>
<p>Brainfuckプログラムが多重実行されるのを防ぐために、実行が終わるまでボタンが押せないようにする。</p>
<p><code>State</code>に実行可能かどうかのフラグを追加する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">::</span> <span class="kt">Boolean</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="kr">_</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">isExecutable</span><span class="kt">:</span> <span class="n">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p><code>isExecutable</code>を使ってボタンが押せるか押せないかを設定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="n">programArea</span> <span class="n">state</span><span class="o">.</span><span class="n">isExecutable</span> <span class="c1">-- 引数追加</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 引数追加</span>
</span></span><span class="line"><span class="cl"><span class="nf">programArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span><span class="o">.</span> <span class="kt">Boolean</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl"><span class="nf">programArea</span> <span class="n">isExecutable</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">textarea</span> <span class="p">[</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onValueChange</span> <span class="kt">ChangeProgram</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">button</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onClick</span> <span class="p">(</span><span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">ExecuteProgram</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span> <span class="kt">HP</span><span class="o">.</span><span class="n">enabled</span> <span class="n">isExecutable</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="s">&#34;Execute&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span></code></pre></div><p>実行時に<code>isExecutable = false</code>にして、実行後に<code>isExecutable = true</code>にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">   <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ExecuteProgram</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">program</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Nothing</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">false</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">B</span><span class="o">.</span><span class="n">run</span> <span class="kt">BIS</span><span class="o">.</span><span class="n">defaultStream</span> <span class="kt">BIL</span><span class="o">.</span><span class="n">noLog</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="n">fromString</span> <span class="n">program</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="n">res</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">true</span> <span class="p">}</span>
</span></span></code></pre></div><h2 id="出力エリアの作成">出力エリアの作成</h2>
<p><a href="https://pursuit.purescript.org/packages/purescript-halogen-subscriptions/1.0.0">halogen-subscriptions</a>パッケージを利用する。</p>
<pre class="cui">
% spago install halogen-subscriptions
</pre>

<p>halogen-subscriptionsを使うと、<code>component</code>の外部から<code>Action</code>を通知することができるようになる。これを用いて、以下の処理を実装する。</p>
<ul>
<li><code>Branfuck.Stream.Stream</code>の<code>output</code>フィールドは、<code>Output Char</code>という<code>Action</code>を通知する。</li>
<li><code>Output Char</code>を通知すると、<code>component</code>は文字を出力する。</li>
</ul>
<p>そのために、Halogen専用のStreamを作成する必要がある。問題はそのStreamをどこに置くかだが、これは2通り考えられる。</p>
<ul>
<li>Componentのinputとして与える。これは<code>Main.purs</code>の<code>runUI</code>の引数で与えられる。</li>
<li><code>State</code>のフィールドとして与え、その初期化は<code>handleAction</code>で行う。</li>
</ul>
<p>後者の欠点はStreamが常に<code>Maybe</code>に包まれてしまうことだが、前者に比べると実装が簡単なので後者を採用する。</p>
<p>まず以下のインポート文を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Interp.Stream</span> <span class="p">(</span><span class="kt">Stream</span><span class="p">(</span><span class="o">..</span><span class="p">))</span> <span class="n">as</span> <span class="kt">BIS</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.String.CodeUnits</span> <span class="p">(</span><span class="nf">singleton</span><span class="p">)</span> <span class="n">as</span> <span class="kt">CodeUnits</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Traversable</span> <span class="p">(</span><span class="nf">for_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff</span> <span class="p">(</span><span class="kt">Aff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff.Class</span> <span class="p">(</span><span class="nf">liftAff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Halogen.Subscription</span> <span class="k">as</span> <span class="n">HS</span>
</span></span></code></pre></div><p><code>for_</code>関数を使いたいので、以下の関連パッケージをインストール。</p>
<pre class="cui">
spago install foldable-traversable
</pre>

<h3 id="staterenderの追加">State、renderの追加</h3>
<p>出力結果を<code>output</code>として、<code>State</code>に持たせる。<code>Stream</code>も<code>State</code>に持たせる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">--- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">streamMay</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">BIS</span><span class="o">.</span><span class="kt">Stream</span> <span class="kt">Aff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">output</span> <span class="ow">::</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="kr">_</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">--- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">streamMay</span><span class="kt">:</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">output</span><span class="kt">:</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>Viewにて、出力エリア<code>outputArea</code>を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="n">programArea</span> <span class="n">state</span><span class="o">.</span><span class="n">isExecutable</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">outputArea</span> <span class="n">state</span><span class="o">.</span><span class="n">output</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kr">case</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">        <span class="kt">Just</span> <span class="n">res</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">interpResult</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl"><span class="nf">outputArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span> <span class="n">i</span><span class="o">.</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="nf">outputArea</span> <span class="n">output</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">p_</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="s">&#34;Output: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">output</span> <span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
</span></span></code></pre></div><h3 id="actionの追加">Actionの追加</h3>
<p>以下の2つの値を追加する。</p>
<ul>
<li><code>Initialize</code>: <code>component</code>の初期化の際に起こる。</li>
<li><code>Output Char</code>: Branfuckの出力命令を踏んだときに起こる。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl">  <span class="ow">=</span> <span class="kt">Initialize</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">ChangeProgram</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">ExecuteProgram</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">Output</span> <span class="kt">Char</span> <span class="c1">-- 追加</span>
</span></span></code></pre></div><p><code>component</code>の初期化の処理を<code>Initialize</code>に任せるために、<code>H.defaultEval</code>の<code>initialize</code>フィールドを設定する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">component</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">H</span><span class="o">.</span><span class="n">mkComponent</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">eval</span><span class="kt">:</span> <span class="kt">H</span><span class="o">.</span><span class="n">mkEval</span> <span class="o">$</span> <span class="kt">H</span><span class="o">.</span><span class="n">defaultEval</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">handleAction</span> <span class="ow">=</span> <span class="n">handleAction</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span> <span class="n">initialize</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="kt">Initialize</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><h3 id="streamの作成">Streamの作成</h3>
<p><code>handleAction</code>の<code>case</code>文に、<code>Initialize</code>を付け足す。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Initialize</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">listener</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="n">liftEffect</span> <span class="kt">HS</span><span class="o">.</span><span class="n">create</span>
</span></span><span class="line"><span class="cl">      <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">subscribe</span> <span class="n">emitter</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">streamMay</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">createStream</span> <span class="n">listener</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">createStream</span> <span class="ow">::</span> <span class="kt">HS</span><span class="o">.</span><span class="kt">Listener</span> <span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="kt">BIS</span><span class="o">.</span><span class="kt">Stream</span> <span class="kt">Aff</span>
</span></span><span class="line"><span class="cl"><span class="nf">createStream</span> <span class="n">listener</span> <span class="ow">=</span> <span class="kt">BIS</span><span class="o">.</span><span class="kt">Stream</span> <span class="p">{</span> <span class="n">input</span><span class="p">,</span> <span class="n">output</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">where</span>
</span></span><span class="line"><span class="cl">    <span class="n">input</span> <span class="ow">=</span> <span class="n">pure</span> <span class="sc">&#39;N&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="n">c</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">HS</span><span class="o">.</span><span class="n">notify</span> <span class="n">listener</span> <span class="p">(</span><span class="kt">Output</span> <span class="n">c</span><span class="p">)</span>
</span></span></code></pre></div><p><code>Output c</code>を追加。<code>c</code>を<code>output</code>に付け足す処理を行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">Output</span> <span class="n">c</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="p">(</span><span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">s</span> <span class="p">{</span> <span class="n">output</span> <span class="ow">=</span> <span class="n">s</span><span class="o">.</span><span class="n">output</span> <span class="o">&lt;&gt;</span> <span class="p">(</span><span class="kt">CodeUnits</span><span class="o">.</span><span class="n">singleton</span> <span class="n">c</span><span class="p">)</span> <span class="p">})</span>
</span></span></code></pre></div><p><code>HS.create</code>は<code>Emitter a</code>と<code>Listener a</code>を返す関数。<code>Emitter a</code>とはイベントの受信者であり、<code>Listener a</code>はイベントの送信者である。
ここでのイベントとは<code>a</code>型の値のことである。<code>String</code>でも<code>Int</code>でもなんでもありえるが、<code>H.subscribe</code>の都合上<code>Action</code>をイベントとする。</p>
<p><code>H.subscribe emitter</code>を使うと、<code>emitter</code>で受け取った<code>Action</code>を<code>handleAction</code>に回すことができる。
<code>HS.notify listener x</code>を使うと、<code>listener</code>に紐づいた<code>emitter</code>に対して値<code>x</code>を送ることができる。</p>
<p>続いて、<code>ExecuteProgram</code>を修正。<code>stream</code>を使って<code>Brainfuck</code>プログラムを走らせる。<code>output</code>は実行の度に空に初期化しておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ExecuteProgram</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">program</span><span class="p">,</span> <span class="n">streamMay</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">      <span class="n">for_</span> <span class="n">streamMay</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">          <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">output</span> <span class="ow">=</span> <span class="s">&#34;&#34;</span> <span class="p">,</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Nothing</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">false</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">liftAff</span> <span class="o">$</span> <span class="kt">B</span><span class="o">.</span><span class="n">run</span> <span class="n">s</span> <span class="kt">BIL</span><span class="o">.</span><span class="n">noLog</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="n">fromString</span> <span class="n">program</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="n">res</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">true</span> <span class="p">}</span>
</span></span></code></pre></div><p>(<strong>補足</strong>) <code>for_</code>について。これは他言語のforループみたいに「与えられた配列一つ一つに対して何か処理をする」ような場合に用いられるが、
以下のように、「<code>Maybe</code>型の値が<code>Just</code>なら何か処理を行い、<code>Nothing</code>なら何もしない」ような場合にも使える。
<code>case</code>文を書かずに済むので、コードが若干見易くなる。</p>
<p><code>bundle-app</code>してみると、Hello, Worldのプログラムが動くようになる。</p>
<figure><img src="img01.png" width="70%"/>
</figure>

<h2 id="入力エリアの作成">入力エリアの作成</h2>
<p><a href="https://pursuit.purescript.org/packages/purescript-avar/4.0.0">avar</a>を利用する。</p>
<pre class="cui">
% spago install avar
</pre>

<p>avarパッケージは<code>AVar a</code>を提供する。これは、<code>a</code>型の値が入る「非同期の変数(<strong>a</strong>synchronous <strong>var</strong>iable)」を表す。
「非同期の変数」と聞くとよく分からないが、ソケット通信におけるソケットのようなものだと理解すれば良さそう。
この<code>AVar a</code>を介してデータのやりとりを行う。</p>
<p><code>AVar a</code>に対し<a href="https://pursuit.purescript.org/packages/purescript-avar/4.0.0/docs/Effect.Aff.AVar#v:put">put</a>で値を入れることができ、
<a href="https://pursuit.purescript.org/packages/purescript-avar/4.0.0/docs/Effect.Aff.AVar#v:take">take</a>で値を取り出すことができる。
大事なのは、<code>take</code>関数は変数に値が入るまで待機するという点である。よって、以下の動作を実現できる。</p>
<ol>
<li>入力命令<code>,</code>を踏むと、入力エリアが出現(これは<code>H.notify</code>を利用すれば可能)</li>
<li><code>take</code>関数で<code>AVar Char</code>に値が入ってくるまで待つ</li>
<li>入力エリアに文字を入力し、確定ボタンを押すと、<code>put</code>関数によって<code>AVar Char</code>に値が入る。</li>
<li>待機中だった<code>take</code>関数が完了し、Brainfuckインタプリタの動作が再開する。</li>
</ol>
<p>以下のインポート文を追加しておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff.AVar</span> <span class="p">(</span><span class="kt">AVar</span><span class="p">,</span> <span class="nf">put</span><span class="p">,</span> <span class="nf">take</span><span class="p">)</span> <span class="n">as</span> <span class="kt">AVar</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.String.CodeUnits</span> <span class="p">(</span><span class="nf">take</span><span class="p">,</span> <span class="nf">toChar</span><span class="p">)</span> <span class="n">as</span> <span class="kt">CodeUnits</span>
</span></span></code></pre></div><h3 id="stateの追加-1">Stateの追加</h3>
<p>以下のフィールドを追加。</p>
<ul>
<li><code>avar</code>: Brainfuckインタプリタと入力エリアをつなぐ変数</li>
<li><code>input</code>: 入力エリアに入っている文字</li>
<li><code>isInputEnabled</code>: 入力エリアが表示されているかどうか</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">avar</span> <span class="ow">::</span> <span class="kt">AVar</span><span class="o">.</span><span class="kt">AVar</span> <span class="kt">Char</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">input</span> <span class="ow">::</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">isInputEnabled</span> <span class="ow">::</span> <span class="kt">Boolean</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p><a href="https://pursuit.purescript.org/packages/purescript-avar/4.0.0/docs/Effect.Aff.AVar#v:empty">empty</a>を利用することで
空の<code>AVar Char</code>を作成することができるが、これは<code>Aff</code>に包まれて返ってきてしまう。
そこで、以下のように<code>initialState</code>の引数に<code>AVar Char</code>を指定する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="ow">::</span> <span class="kt">AVar</span><span class="o">.</span><span class="kt">AVar</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">State</span>
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="n">avar</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">avar</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">input</span><span class="kt">:</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">isInputEnabled</span><span class="kt">:</span> <span class="n">false</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>この引数はどこから与えられるのかというと、<code>src/Main.purs</code>の<code>runUI</code>で与えられる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff.AVar</span> <span class="p">(</span><span class="nf">empty</span><span class="p">)</span> <span class="n">as</span> <span class="kt">AVar</span> <span class="c1">--追加</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="ow">=</span> <span class="kt">HA</span><span class="o">.</span><span class="n">runHalogenAff</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">body</span> <span class="ow">&lt;-</span> <span class="kt">HA</span><span class="o">.</span><span class="n">awaitBody</span>
</span></span><span class="line"><span class="cl">  <span class="n">avar</span> <span class="ow">&lt;-</span> <span class="kt">AVar</span><span class="o">.</span><span class="n">empty</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">  <span class="n">runUI</span> <span class="n">component</span> <span class="n">avar</span> <span class="n">body</span> <span class="c1">-- 引数をunitからavarに変更。</span>
</span></span></code></pre></div><p><code>input</code>が<code>AVar Char</code>になったのに伴い、<code>src/Component.purs</code>の<code>component</code>の引数を変更。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">component</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">query</span> <span class="n">output</span> <span class="n">m</span><span class="o">.</span> <span class="kt">MonadAff</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">Component</span> <span class="n">query</span> <span class="p">(</span><span class="kt">AVar</span><span class="o">.</span><span class="kt">AVar</span> <span class="kt">Char</span><span class="p">)</span> <span class="n">output</span> <span class="n">m</span>
</span></span></code></pre></div><h3 id="actionの追加-1">Actionの追加</h3>
<p>3つの<code>Action</code>を追加</p>
<ul>
<li><code>RequestInput</code>: Brainfuckインタプリタが<code>,</code>命令を踏んだときに起こる。</li>
<li><code>ChangeInput String</code>: 入力エリアにテキストを入力したときに起こる</li>
<li><code>ConfirmInput</code>: 入力確定ボタンが押されたときに起こる。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl">  <span class="ow">=</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">RequestInput</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">ChangeInput</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">ConfirmInput</span>
</span></span></code></pre></div><p><code>handleAction</code>に追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">RequestInput</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">isInputEnabled</span> <span class="ow">=</span> <span class="n">true</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ChangeInput</span> <span class="n">input</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">input</span> <span class="ow">=</span> <span class="n">input</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ConfirmInput</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">avar</span><span class="p">,</span> <span class="n">input</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">      <span class="kr">case</span> <span class="kt">CodeUnits</span><span class="o">.</span><span class="n">toChar</span> <span class="o">$</span> <span class="kt">CodeUnits</span><span class="o">.</span><span class="n">take</span> <span class="mi">1</span> <span class="n">input</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">        <span class="kt">Just</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">          <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">input</span> <span class="ow">=</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">isInputEnabled</span> <span class="ow">=</span> <span class="n">false</span> <span class="p">}</span> <span class="c1">-- (*1)</span>
</span></span><span class="line"><span class="cl">          <span class="n">liftAff</span> <span class="o">$</span> <span class="kt">AVar</span><span class="o">.</span><span class="n">put</span> <span class="n">c</span> <span class="n">avar</span> <span class="c1">-- (*2)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">pure</span> <span class="n">unit</span>
</span></span></code></pre></div><p>(<strong>注意</strong>)  <code>(*1)</code>と <code>(*2)</code>を逆にすると正常に動作しないことに注意。<code>,</code>が2回以上現れるプログラムで、入力エリアが1度しか現れない。
その理由は<code>isInputEnabled</code>が<code>false</code>になるタイミングと2回目の<code>RequestInput</code>が投げられるタイミングを考えると分かる。
BrainfuckとComponent間でのデータのやりとりはある種の通信と捉えられるが、通信を扱うときには処理を行うタイミングについてより慎重になる必要がありそう。</p>
<p><code>stream</code>が<code>avar</code>を使えるように、<code>createStream</code>の引数を変更する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Initialize</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">listener</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="n">liftEffect</span> <span class="kt">HS</span><span class="o">.</span><span class="n">create</span>
</span></span><span class="line"><span class="cl">      <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">subscribe</span> <span class="n">emitter</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">s</span> <span class="p">{</span> <span class="n">streamMay</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">createStream</span> <span class="n">listener</span> <span class="n">s</span><span class="o">.</span><span class="n">avar</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">createStream</span> <span class="ow">::</span> <span class="kt">HS</span><span class="o">.</span><span class="kt">Listener</span> <span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="kt">AVar</span><span class="o">.</span><span class="kt">AVar</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">BIS</span><span class="o">.</span><span class="kt">Stream</span> <span class="kt">Aff</span>
</span></span><span class="line"><span class="cl"><span class="nf">createStream</span> <span class="n">listener</span> <span class="n">avar</span> <span class="ow">=</span> <span class="kt">BIS</span><span class="o">.</span><span class="kt">Stream</span> <span class="p">{</span> <span class="n">input</span><span class="p">,</span> <span class="n">output</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">where</span>
</span></span><span class="line"><span class="cl">    <span class="n">input</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">HS</span><span class="o">.</span><span class="n">notify</span> <span class="n">listener</span> <span class="kt">RequestInput</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftAff</span> <span class="o">$</span> <span class="kt">AVar</span><span class="o">.</span><span class="n">take</span> <span class="n">avar</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="n">c</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">HS</span><span class="o">.</span><span class="n">notify</span> <span class="n">listener</span> <span class="p">(</span><span class="kt">Output</span> <span class="n">c</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="renderの実装">renderの実装</h3>
<p>入力エリアを実装する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="n">programArea</span> <span class="n">state</span><span class="o">.</span><span class="n">isExecutable</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 以下3行を追加</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kr">if</span> <span class="n">state</span><span class="o">.</span><span class="n">isInputEnabled</span> 
</span></span><span class="line"><span class="cl">        <span class="kr">then</span> <span class="n">inputArea</span>
</span></span><span class="line"><span class="cl">        <span class="kr">else</span> <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">outputArea</span> <span class="n">state</span><span class="o">.</span><span class="n">output</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl"><span class="nf">inputArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span><span class="o">.</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl"><span class="nf">inputArea</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">input</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="kt">HP</span><span class="o">.</span><span class="n">type_</span> <span class="kt">HP</span><span class="o">.</span><span class="kt">InputText</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onValueChange</span> <span class="kt">ChangeInput</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kt">HH</span><span class="o">.</span><span class="n">button</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="kt">HE</span><span class="o">.</span><span class="n">onClick</span> <span class="p">(</span><span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">ConfirmInput</span><span class="p">)</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="s">&#34;input&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span></code></pre></div><p>3文字の入力を促して、アルファベットを1ずらして出力するBrainfuckプログラムを書いてみる。</p>
<figure><img src="mov00.gif" width="70%"/>
</figure>

<p>結果が<code>bcd</code>になってくれている。</p>
<h2 id="プログラムの実行中の様子を可視化する">プログラムの実行中の様子を可視化する</h2>
<p>Brainfuckインタプリタの動きを可視化するためには、ステップごとのプログラムの状態をComponentに出力してあげる必要がある。
これを実装するには前回実装した、<code>Brainfuck.Interp.Log</code>の<code>Log m</code>を使えば良い。具体的には、以下の手順を実装する。</p>
<ol>
<li>Brainfuckインタプリタの各ステップで<code>Log m</code>の<code>onState</code>が呼ばれる。このとき<code>RequestLogState state</code>という<code>Action</code>が通知される。</li>
<li><code>RequestLogState state</code>を<code>handleAction</code>で受け取り、<code>State</code>のフィールドとして格納される。</li>
<li><code>render</code>で<code>state</code>を描画する。</li>
</ol>
<p>以下のimport文を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Interp.Log</span> <span class="p">(</span><span class="kt">Log</span><span class="p">(</span><span class="o">..</span><span class="p">))</span> <span class="n">as</span> <span class="kt">BIL</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Brainfuck.Program</span> <span class="p">(</span><span class="kt">Program</span><span class="p">(</span><span class="o">..</span><span class="p">))</span> <span class="n">as</span> <span class="kt">BP</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Array</span> <span class="p">(</span><span class="nf">mapWithIndex</span><span class="p">)</span> <span class="n">as</span> <span class="kt">Array</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Effect.Aff</span> <span class="p">(</span><span class="nf">delay</span><span class="p">,</span> <span class="kt">Milliseconds</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="stateの定義">Stateの定義</h3>
<p><code>Log m</code>を<code>State</code>のフィールドに持たせる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">State</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">logMay</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">BIL</span><span class="o">.</span><span class="kt">Log</span> <span class="kt">Aff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">stateMay</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">BS</span><span class="o">.</span><span class="kt">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="ow">::</span> <span class="kt">AVar</span><span class="o">.</span><span class="kt">AVar</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">State</span>
</span></span><span class="line"><span class="cl"><span class="nf">initialState</span> <span class="n">avar</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">logMay</span><span class="kt">:</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">stateMay</span><span class="kt">:</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h3 id="logの定義">Logの定義</h3>
<p>Logを作成する関数<code>createLogState</code>を作る。これは<code>RequestLogState state</code>を通知する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">createLog</span> <span class="ow">::</span> <span class="kt">HS</span><span class="o">.</span><span class="kt">Listener</span> <span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="kt">BIL</span><span class="o">.</span><span class="kt">Log</span> <span class="kt">Aff</span>
</span></span><span class="line"><span class="cl"><span class="nf">createLog</span> <span class="n">listener</span> <span class="ow">=</span> <span class="kt">BIL</span><span class="o">.</span><span class="kt">Log</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">onStart</span><span class="kt">:</span> <span class="n">pure</span> <span class="n">unit</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">onState</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">onCmd</span><span class="kt">:</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="n">unit</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">onEnd</span><span class="kt">:</span> <span class="n">pure</span> <span class="n">unit</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">where</span>
</span></span><span class="line"><span class="cl">    <span class="n">onState</span> <span class="n">state</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftEffect</span> <span class="o">$</span> <span class="kt">HS</span><span class="o">.</span><span class="n">notify</span> <span class="n">listener</span> <span class="p">(</span><span class="kt">RequestLogState</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftAff</span> <span class="o">$</span> <span class="n">delay</span> <span class="p">(</span><span class="kt">Milliseconds</span> <span class="mf">100.0</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="actionの定義">Actionの定義</h3>
<p><code>RequestLogState</code>を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Action</span>
</span></span><span class="line"><span class="cl">  <span class="ow">=</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span> <span class="kt">RequestLogState</span> <span class="kt">BS</span><span class="o">.</span><span class="kt">State</span>
</span></span></code></pre></div><p><code>handleAction</code>の<code>Initialize</code>の際に、<code>logMay</code>をセットする。</p>
<p><code>RequestLogState</code>が起こると、<code>stateMay</code>に現在のプログラムの状態をセットする。</p>
<p><code>ExecuteProgram</code>の<code>B.run</code>の引数にLogが指定できるよう修正。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">handleAction</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> <span class="kr">_</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Initialize</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">listener</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="n">liftEffect</span> <span class="kt">HS</span><span class="o">.</span><span class="n">create</span>
</span></span><span class="line"><span class="cl">      <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">subscribe</span> <span class="n">emitter</span>
</span></span><span class="line"><span class="cl">      <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="p">{</span> <span class="n">streamMay</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">createStream</span> <span class="n">listener</span> <span class="n">s</span><span class="o">.</span><span class="n">avar</span>
</span></span><span class="line"><span class="cl">          <span class="p">,</span> <span class="n">logMay</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">createLog</span> <span class="n">listener</span> <span class="c1">-- 追加</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">RequestLogState</span> <span class="n">state</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">       <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">stateMay</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="n">state</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ExecuteProgram</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="n">program</span><span class="p">,</span> <span class="n">streamMay</span><span class="p">,</span> <span class="n">logMay</span> <span class="p">}</span> <span class="ow">&lt;-</span> <span class="kt">H</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">      <span class="n">for_</span> <span class="n">streamMay</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">for_</span> <span class="n">logMay</span> <span class="nf">\</span><span class="n">l</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">          <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">output</span> <span class="ow">=</span> <span class="s">&#34;&#34;</span> <span class="p">,</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Nothing</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">false</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">liftAff</span> <span class="o">$</span> <span class="kt">B</span><span class="o">.</span><span class="n">run</span> <span class="n">s</span> <span class="n">l</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="n">fromString</span> <span class="n">program</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kt">H</span><span class="o">.</span><span class="n">modify_</span> <span class="kr">_</span> <span class="p">{</span> <span class="n">result</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="n">res</span><span class="p">,</span> <span class="n">isExecutable</span> <span class="ow">=</span> <span class="n">true</span> <span class="p">}</span>
</span></span></code></pre></div><h3 id="viewの定義">Viewの定義</h3>
<p>現在の状態を表示するエリアを作成。
インストラクションポインタの指す命令、メモリの指す命令には色をつけて表示する。
<code>memory</code>の表示については要素間の間隔が詰まっていて見づらいため、<code>margin-right</code>を指定している。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="nf">render</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">m</span><span class="o">.</span> <span class="kt">State</span> <span class="ow">-&gt;</span> <span class="kt">H</span><span class="o">.</span><span class="kt">ComponentHTML</span> <span class="kt">Action</span> <span class="nb">()</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl"><span class="nf">render</span> <span class="n">state</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="kr">case</span> <span class="n">state</span><span class="o">.</span><span class="n">stateMay</span> <span class="kr">of</span>
</span></span><span class="line"><span class="cl">        <span class="kt">Just</span> <span class="n">s</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">stateArea</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="n">fromString</span> <span class="n">state</span><span class="o">.</span><span class="n">program</span><span class="p">)</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="c1">-- 略</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">stateArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span> <span class="n">i</span><span class="o">.</span> <span class="kt">BP</span><span class="o">.</span><span class="kt">Program</span> <span class="ow">-&gt;</span> <span class="kt">BS</span><span class="o">.</span><span class="kt">State</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="nf">stateArea</span> <span class="n">program</span> <span class="p">(</span><span class="kt">BS</span><span class="o">.</span><span class="kt">State</span> <span class="p">{</span> <span class="n">iptr</span><span class="p">,</span> <span class="n">dptr</span><span class="p">,</span> <span class="n">memory</span> <span class="p">})</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="n">programLogArea</span> <span class="n">iptr</span> <span class="n">program</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="n">memoryLogArea</span> <span class="n">dptr</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">mapWithASpecialIndex</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span><span class="o">.</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Array</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Array</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">mapWithASpecialIndex</span> <span class="n">j</span> <span class="n">fThen</span> <span class="n">fElse</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">Array</span><span class="o">.</span><span class="n">mapWithIndex</span> <span class="p">(</span><span class="nf">\</span><span class="n">i</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="kr">then</span> <span class="n">fThen</span> <span class="n">x</span> <span class="kr">else</span> <span class="n">fElse</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">programLogArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span> <span class="n">i</span><span class="o">.</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">BP</span><span class="o">.</span><span class="kt">Program</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="nf">programLogArea</span> <span class="n">iptr</span> <span class="p">(</span><span class="kt">BP</span><span class="o">.</span><span class="kt">Program</span> <span class="n">program</span><span class="p">)</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">    <span class="n">mapWithASpecialIndex</span> <span class="n">iptr</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">\</span><span class="n">cmd</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="n">span</span> <span class="p">[</span> <span class="kt">HP</span><span class="o">.</span><span class="n">style</span> <span class="s">&#34;background-color: salmon;&#34;</span> <span class="p">]</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="o">$</span> <span class="n">show</span> <span class="n">cmd</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">\</span><span class="n">cmd</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="n">span</span> <span class="p">[</span> <span class="kt">HP</span><span class="o">.</span><span class="n">style</span> <span class="s">&#34;background-color: white;&#34;</span> <span class="p">]</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="o">$</span> <span class="n">show</span> <span class="n">cmd</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="n">program</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">memoryLogArea</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">w</span> <span class="n">i</span><span class="o">.</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Array</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="kt">HTML</span> <span class="n">w</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="nf">memoryLogArea</span> <span class="n">dptr</span> <span class="n">memory</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kt">HH</span><span class="o">.</span><span class="n">div_</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">    <span class="n">mapWithASpecialIndex</span> <span class="n">dptr</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">\</span><span class="n">dat</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="n">span</span> <span class="p">[</span> <span class="kt">HP</span><span class="o">.</span><span class="n">style</span> <span class="s">&#34;background-color: salmon; margin-right: 1em;&#34;</span> <span class="p">]</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="o">$</span> <span class="n">show</span> <span class="n">dat</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">\</span><span class="n">dat</span> <span class="ow">-&gt;</span> <span class="kt">HH</span><span class="o">.</span><span class="n">span</span> <span class="p">[</span> <span class="kt">HP</span><span class="o">.</span><span class="n">style</span> <span class="s">&#34;background-color: white; margin-right: 1em;&#34;</span> <span class="p">]</span> <span class="p">[</span> <span class="kt">HH</span><span class="o">.</span><span class="n">text</span> <span class="o">$</span> <span class="n">show</span> <span class="n">dat</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="n">memory</span>
</span></span></code></pre></div><p>いい感じで可視化されている。</p>
<figure><img src="mov01.gif" width="70%"/>
</figure>

<h2 id="ソースコードとデモ">ソースコードとデモ</h2>
<p>CSSやHTML要素の順番などを微調整したバージョンを
<a href="https://github.com/bombrary/brainfuck-purescript">GitHubのRepositry</a>に上げた。
実際に動くものを<a href="https://bombrary.github.io/brainfuck-purescript/">GitHub Pages</a>に上げた。</p>
<h2 id="感想とまとめ">感想とまとめ</h2>
<h3 id="brainfuckの思い出">Brainfuckの思い出</h3>
<p>Brainfuckとの初めての出会いは<a href="https://www.nicovideo.jp/watch/sm10384056">BrainfuckをJavaScriptを使って実装する動画</a>を見つけたところからだった。
当時プログラミングは学んでおらず、書いていることや喋っている意味はまったく分からなかった。分からないけど、なんか面白そう、とは思っていた。</p>
<p>その2、3年後くらいにC言語を学び、力試しとしてBrainfuckを作った。とはいえ単に文字列を1文字づつ見ていくだけだし、入出力はそれぞれ<code>printf</code>と<code>scanf</code>で行う簡単なものだった。</p>
<p>さらに年月は経ち、大学のJavaの授業でSwingを使ったGUIアプリ作成の課題があったのだが、電卓にBrainfuckを組み込んだ。
オブジェクト指向に入門したのがこのときで、Brainfuckインタプリタをクラスとして分離して汎用性を持たせようとした記憶がある。
入力命令は面倒だと考え実装しなかった。</p>
<p>そして今回、PureScriptでBrainfuckを作った。</p>
<h3 id="まとめ">まとめ</h3>
<p>PureScriptでBrainfuckインタプリタを作成した。インタプリタの骨組みを作り、それがCUI、GUI両方で使えることを示した。
インタプリタの動作の様子を可視化する仕組みも実装した。</p>
<p>Brainfuckなんて、抽象化を気にせずC言語で書くと、以下のように60行に満たない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define S_SIZE 1100
</span></span></span><span class="line"><span class="cl"><span class="cp">#define D_SIZE 31000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">S</span><span class="p">[</span><span class="n">S_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">data</span><span class="p">[</span><span class="n">D_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">dp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">S</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;q&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// qを入力すると終了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">dp</span> <span class="o">&lt;</span> <span class="n">D_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dp</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dp</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">dp</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">dp</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dp</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">ip</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">dp</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">ip</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">dp</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">ip</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>しかし今回PureScriptでBrainfuckを実装するにあたり、</p>
<ul>
<li>命令を代数的データで扱う:
(文字の書き間違いにある程度は気づけるようになるし、<code>&gt;&lt;+-.,[]</code>以外の命令セットにも対応できるようになるため。</li>
<li>入出力に汎用性を持たせる。</li>
<li>可視化をする。</li>
<li>適当にモジュールに分割する</li>
</ul>
<p>などの制約を自分に課した結果、結構実装が大変になった。そして想像以上に長い記事となってしまった。</p>
<p>しかし実装に当たって初めて使ったパッケージ(avar, refs, halogen-subscriptionsなど)もあったし、
実装に当たってモナド変換子を利用できたので非常に勉強になった。</p>

</article>



</html>
