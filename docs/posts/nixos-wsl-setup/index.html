<!DOCTYPE html>
<html lang="ja-jp">
<title>NixOSをWSL2上で構築したときのメモ | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.121.1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/index.css">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/nixos-wsl-setup/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
  <link rel="stylesheet" href="/blog/css/custom.css">

  <link rel="stylesheet" href="/blog/css/syntax.css">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>



<meta property="og:title" content="NixOSをWSL2上で構築したときのメモ" />
<meta property="og:description" content="年末からお正月の間帰省したときにWindowsのラップトップを持っていった。しかしWSL2にはUbuntuしか入っておらず、最近デスクトップで使っているNixOSが入っていなかった。そこで試しに構築してみたときのメモ。最低限コーディングができる環境が整った。
（IT系あるあるだけれど）NixOS-WSLの開発はまあまあ早いため、ここに書いてある内容もすぐ陳腐化してしまいそう。
インストール RepositoryのReleasesからnixos-wsl.tar.gzをDLしてくる
コマンドプロンプト or PowerShell で以下のコマンドを実行
wsl --import NixOS .\NixOS\ nixos-wsl.tar.gz --version 2 wsl -d NixOS nix-channel --update Flake化による初回セットアップ 今回はなるべくnix-channelを使わず、flake.nixからなるべく必要なファイルを入れるようにしたい。そのほうが、今後再セットアップするときにそのflakeファイルを指定するだけで環境が構築できることを期待しているため。
とはいえ、現状のNixOSにはVimもGitも入っておらず限界があるので、それはChannelから入手する。まず現時点での最新版のnixosのChannelを登録する。
sudo nix-channel --add https://nixos.org/channels/nixos-23.11 nixos sudo nix-channel --update 次にVimとGitを入れる
nix-shell -p vim git NixOSで最強のLinuxデスクトップを作ろうやUsing nix flakes with NixOSに書かれている内容を参考に進めていく。まずconfiguration.nixを持ってくる。
cp /etc/nixos/* . flake.nixを作成し以下のようにする。
inputsにnixosのリポジトリと、NixOS-WSLのリポジトリを指定する inputsの書き方はattribute setとurl-likeな書き方の2種類がある。url-likeな書き方だとtag指定の方法がわからなかったので、NixOS-WSLのinputに関してはattribute setで書いている nixosSystemの引数としてspecialArgsが指定でき、これでconfiguration.nixに引数を渡せる { inputs = { nixos.url = &#34;github:NixOS/nixpkgs/nixos-23.11&#34;; nixos-wsl = { type = &#34;github&#34;; owner = &#34;nix-community&#34;; repo = &#34;NixOS-WSL&#34;; ref = &#34;2311." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bombrary.github.io/blog/posts/nixos-wsl-setup/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-13T11:23:15+09:00" />
<meta property="article:modified_time" content="2024-01-13T13:08:42+09:00" />


<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="NixOSをWSL2上で構築したときのメモ"/>
<meta name="twitter:description" content="年末からお正月の間帰省したときにWindowsのラップトップを持っていった。しかしWSL2にはUbuntuしか入っておらず、最近デスクトップで使っているNixOSが入っていなかった。そこで試しに構築してみたときのメモ。最低限コーディングができる環境が整った。
（IT系あるあるだけれど）NixOS-WSLの開発はまあまあ早いため、ここに書いてある内容もすぐ陳腐化してしまいそう。
インストール RepositoryのReleasesからnixos-wsl.tar.gzをDLしてくる
コマンドプロンプト or PowerShell で以下のコマンドを実行
wsl --import NixOS .\NixOS\ nixos-wsl.tar.gz --version 2 wsl -d NixOS nix-channel --update Flake化による初回セットアップ 今回はなるべくnix-channelを使わず、flake.nixからなるべく必要なファイルを入れるようにしたい。そのほうが、今後再セットアップするときにそのflakeファイルを指定するだけで環境が構築できることを期待しているため。
とはいえ、現状のNixOSにはVimもGitも入っておらず限界があるので、それはChannelから入手する。まず現時点での最新版のnixosのChannelを登録する。
sudo nix-channel --add https://nixos.org/channels/nixos-23.11 nixos sudo nix-channel --update 次にVimとGitを入れる
nix-shell -p vim git NixOSで最強のLinuxデスクトップを作ろうやUsing nix flakes with NixOSに書かれている内容を参考に進めていく。まずconfiguration.nixを持ってくる。
cp /etc/nixos/* . flake.nixを作成し以下のようにする。
inputsにnixosのリポジトリと、NixOS-WSLのリポジトリを指定する inputsの書き方はattribute setとurl-likeな書き方の2種類がある。url-likeな書き方だとtag指定の方法がわからなかったので、NixOS-WSLのinputに関してはattribute setで書いている nixosSystemの引数としてspecialArgsが指定でき、これでconfiguration.nixに引数を渡せる { inputs = { nixos.url = &#34;github:NixOS/nixpkgs/nixos-23.11&#34;; nixos-wsl = { type = &#34;github&#34;; owner = &#34;nix-community&#34;; repo = &#34;NixOS-WSL&#34;; ref = &#34;2311."/>


<header>
  
    <a href="https://bombrary.github.io/blog/" class="title">Chanomic Blog</a>
  
  
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/nixos-wsl-setup/">NixOSをWSL2上で構築したときのメモ</a></h1>
    <div class="meta">
      
      <div class="pub-date">
        <time datetime="2024-01-13T11:23:15&#43;09:00">January 13, 2024</time>
      </div>
      
      
      <div class="lastmod-date">
        <div class="lastmod-date__label">(last modified:</div>
        <time datetime="2024-01-13T11:23:15&#43;09:00">January 13, 2024</time>
        <div class="lastmod-date__label">)</div>
      </div>
      
    </div>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/wsl/">WSL</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/nixos/">NixOS</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="categories_item"><a href="https://bombrary.github.io/blog//categories/setup/">setup</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  
  <p>年末からお正月の間帰省したときにWindowsのラップトップを持っていった。しかしWSL2にはUbuntuしか入っておらず、最近デスクトップで使っている<a href="https://nixos.org/">NixOS</a>が入っていなかった。そこで試しに構築してみたときのメモ。最低限コーディングができる環境が整った。</p>
<p>（IT系あるあるだけれど）<a href="https://github.com/nix-community/NixOS-WSL">NixOS-WSL</a>の開発はまあまあ早いため、ここに書いてある内容もすぐ陳腐化してしまいそう。</p>
<h2 id="インストール">インストール</h2>
<p><a href="https://github.com/nix-community/NixOS-WSL">Repository</a>のReleasesから<code>nixos-wsl.tar.gz</code>をDLしてくる</p>
<p>コマンドプロンプト or PowerShell で以下のコマンドを実行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps" data-lang="ps"><span class="line"><span class="cl"><span class="nf">wsl</span> <span class="nf">--import</span> <span class="nf">NixOS</span> <span class="nf">.\NixOS\</span> <span class="nf">nixos-wsl.tar.gz</span> <span class="nf">--version</span> <span class="mf">2</span>
</span></span><span class="line"><span class="cl"><span class="nf">wsl</span> <span class="nf">-d</span> <span class="nf">NixOS</span>
</span></span><span class="line"><span class="cl"><span class="nf">nix-channel</span> <span class="nf">--update</span>
</span></span></code></pre></div><h2 id="flake化による初回セットアップ">Flake化による初回セットアップ</h2>
<p>今回はなるべくnix-channelを使わず、flake.nixからなるべく必要なファイルを入れるようにしたい。そのほうが、今後再セットアップするときにそのflakeファイルを指定するだけで環境が構築できることを期待しているため。</p>
<p>とはいえ、現状のNixOSにはVimもGitも入っておらず限界があるので、それはChannelから入手する。まず現時点での最新版のnixosのChannelを登録する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo nix-channel --add https://nixos.org/channels/nixos-23.11 nixos
</span></span><span class="line"><span class="cl">sudo nix-channel --update
</span></span></code></pre></div><p>次にVimとGitを入れる</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix-shell -p vim git
</span></span></code></pre></div><p><a href="https://zenn.dev/asa1984/articles/nixos-is-the-best#flake%E5%8C%96">NixOSで最強のLinuxデスクトップを作ろう</a>や<a href="https://nixos.wiki/wiki/Flakes#Using_nix_flakes_with_NixOS">Using nix flakes with NixOS</a>に書かれている内容を参考に進めていく。まず<code>configuration.nix</code>を持ってくる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cp /etc/nixos/* .
</span></span></code></pre></div><p><code>flake.nix</code>を作成し以下のようにする。</p>
<ul>
<li>inputsにnixosのリポジトリと、NixOS-WSLのリポジトリを指定する
<ul>
<li><a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#flake-references">inputs</a>の書き方はattribute setとurl-likeな書き方の2種類がある。url-likeな書き方だとtag指定の方法がわからなかったので、NixOS-WSLのinputに関してはattribute setで書いている</li>
</ul>
</li>
<li>nixosSystemの引数として<code>specialArgs</code>が指定でき、これで<code>configuration.nix</code>に引数を渡せる</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nixos</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;github:NixOS/nixpkgs/nixos-23.11&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nixos-wsl</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;github&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">owner</span> <span class="o">=</span> <span class="s2">&#34;nix-community&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">repo</span> <span class="o">=</span> <span class="s2">&#34;NixOS-WSL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ref</span> <span class="o">=</span> <span class="s2">&#34;2311.5.3&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">outputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nixosConfigurations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">wsl</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nixos</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">nixosSystem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">system</span> <span class="o">=</span> <span class="s2">&#34;x86_64-linux&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="sr">./configuration.nix</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">specialArgs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">nixos-wsl</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nixos-wsl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>現在、<code>configuration.nix</code>ではWSL用のモジュールを<code>nixos-wsl</code> Channelから取得するようになっている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; sudo nix-channel --list
</span></span><span class="line"><span class="cl">nixos https://nixos.org/channels/nixos-23.11
</span></span><span class="line"><span class="cl">nixos-wsl https://github.com/nix-community/NixOS-WSL/archive/refs/heads/main.tar.gz
</span></span></code></pre></div><p>もしそのまま実行したいなら、以下のコマンドでビルドが可能。<code>--impore</code>引数をつける必要がある。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo nixos-rebuild switch --impure --flake .#wsl
</span></span></code></pre></div><p>しかしこのままだとローカルな環境のChannelに依存することになってしまう。flakeでビルドするときはflakeだけで完結させたいので、Channelを使わないような設定に書き換える。そのために、cpでコピーしてきた<code>configuration.nix</code>を編集する。</p>
<ul>
<li>引数に<code>nixos-wsl</code>を追加。これは先ほど<code>flake.nix</code>で<code>specialArgs</code>として指定したattributeに当たる</li>
<li><code>&lt;nixos-wsl/modules&gt;</code>のところを<code>nixos-wsl.nixosModules</code>に変える</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">lib</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="n">nixos-wsl</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">imports</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># include NixOS-WSL modules</span>
</span></span><span class="line"><span class="cl">    <span class="n">nixos-wsl</span><span class="o">.</span><span class="n">nixosModules</span><span class="o">.</span><span class="n">wsl</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>これで、次のように<code>--impure</code>無しでコマンドが実行可能になる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo nixos-rebuild switch --flake .#wsl
</span></span></code></pre></div><h2 id="flakeの有効化">Flakeの有効化</h2>
<p><code>configuration.nix</code>に以下を追記。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">lib</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="n">nixos-wsl</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">nix</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">experimental-features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;nix-command&#34;</span> <span class="s2">&#34;flakes&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="ユーザの追加">ユーザの追加</h2>
<ul>
<li><code>configuration.nix</code>で、自分ユーザの設定を追加しておく。</li>
<li>今ログインしている<code>nixos</code>ユーザの設定を変えるのは余計なトラブルの元になりそうなので避ける</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">lib</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="n">nixos-wsl</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">wsl</span><span class="o">.</span><span class="n">defaultUser</span> <span class="o">=</span> <span class="s2">&#34;nixos&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">users</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="err">ユーザ名</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">shell</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">fish</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">isNormalUser</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">extraGroups</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;wheel&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">security</span><span class="o">.</span><span class="n">sudo</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ビルド後、<code>sudo passwd ユーザ名</code> でユーザのパスワードを設定しておく。</p>
<p>ユーザを指定してログインしたい場合は、<code>-u</code>をつけてログインが可能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps" data-lang="ps"><span class="line"><span class="cl"><span class="nf">（コマンドプロンプト</span> <span class="nf">or</span> <span class="nf">PowerShell内で）</span>
</span></span><span class="line"><span class="cl"><span class="nf">wsl</span> <span class="nf">-d</span> <span class="nf">NixOS</span> <span class="nf">-u</span> <span class="nf">ユーザ名</span>
</span></span></code></pre></div><p>何か設定を間違えてsudoできなくなってしまったという場合には、rootでログインするという手もあるので覚えておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps" data-lang="ps"><span class="line"><span class="cl"><span class="nf">（コマンドプロンプト</span> <span class="nf">or</span> <span class="nf">PowerShell内で）</span>
</span></span><span class="line"><span class="cl"><span class="nf">wsl</span> <span class="nf">-d</span> <span class="nf">NixOS</span> <span class="nf">-u</span> <span class="nf">root</span>
</span></span></code></pre></div><h3 id="余談">余談</h3>
<p><code>isNormalUser</code>の指定がなかった場合にビルドしたときのエラー。ありえないくらい親切にエラーを出してくれる。</p>
<pre tabindex="0"><code>error:
Failed assertions:
- Exactly one of users.users.bombrary.isSystemUser and users.users.bombrary.isNormalUser must be set.

- users.users.bombrary.group is unset. This used to default to
nogroup, but this is unsafe. For example you can create a group
for this user with:
users.users.bombrary.group = &#34;bombrary&#34;;
users.groups.bombrary = {};

- users.users.bombrary.shell is set to fish, but
programs.fish.enable is not true. This will cause the fish
shell to lack the basic nix directories in its PATH and might make
logging in as that user impossible. You can fix it with:
programs.fish.enable = true;

If you know what you&#39;re doing and you are fine with the behavior,
set users.users.bombrary.ignoreShellProgramCheck = true;
instead.
</code></pre><h2 id="home-managerの設定">home-managerの設定</h2>
<p>自分のユーザでログインする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">su ユーザ名
</span></span><span class="line"><span class="cl">nix-shell -p git vim
</span></span></code></pre></div><p><code>.doftiles</code>を持ってくる</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cp -r /home/nixos/.dotfiles .
</span></span></code></pre></div><p><code>flake.nix</code>にhome-managerの設定を追記する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">nixpkgs</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">home-manager</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;github:nix-community/home-manager&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">inputs</span><span class="o">.</span><span class="n">nixpkgs</span><span class="o">.</span><span class="n">follows</span> <span class="o">=</span> <span class="s2">&#34;nixpkgs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">outputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">homeConfigurations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">myHome</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">home-manager</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">homeManagerConfiguration</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkgs</span> <span class="o">=</span> <span class="kn">import</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nixpkgs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">system</span> <span class="o">=</span> <span class="s2">&#34;x86_64-linux&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">config</span><span class="o">.</span><span class="n">allowUnfree</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">extraSpecialArgs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">inherit</span> <span class="n">inputs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="sr">./home.nix</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>home.nix</code>をまず次のようにする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">home</span> <span class="o">=</span> <span class="k">rec</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="s2">&#34;ユーザ名&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">homeDirectory</span> <span class="o">=</span> <span class="s2">&#34;/home/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">stateVersion</span> <span class="o">=</span> <span class="s2">&#34;23.11&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="n">programs</span><span class="o">.</span><span class="n">home-manager</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>初回設定の適用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; nix run home-manager -- switch --flake .#myHome
</span></span></code></pre></div><p>後は<code>home.nix</code>を書き換えて好きなパッケージを入れる。</p>

</article>



</html>
