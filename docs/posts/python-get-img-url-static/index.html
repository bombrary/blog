<!DOCTYPE html>
<html lang="ja-jp">
<title>Pythonを使った(静的)ページの画像のURL取得 | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.121.1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/index.css">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/python-get-img-url-static/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
  <link rel="stylesheet" href="/blog/css/custom.css">

  <link rel="stylesheet" href="/blog/css/syntax.css">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>



<meta property="og:title" content="Pythonを使った(静的)ページの画像のURL取得" />
<meta property="og:description" content="Webページの画像だけを手っ取り早く取得したい場合にどうすれば良いのかを考えた。 これを行うプログラムをPythonで取得する。
この記事で作成したプログラムはGitHubのRepositoryに公開した。
前提 Pythonのバージョンは3.10を想定。
この記事では外部ライブラリとして
Requests 2.26.0 Beautiful Soup 4.10.0 tqdm 4.62.3 w3lib 1.22.0 を使う。この記事のコードを動かす場合はpipコマンドなどでインストールしておく。
方針 やることは案外単純である。
WebページのHTMLデータを取ってくる。 img要素を探して、そのsrc属性を取ってくる。 scheme、netlocが無かったらそれを付加して、完全なURLにする。 1はRequests、2はBeautiful Soupを使えば良いだろう。 3は思ったより複雑である。src属性に入っているパスには、
URL: http://foo.org/bar/hoge.png スキームが省略されている: //foo.org/bar/hoge.png 絶対パス: /bar/hoge.png 相対パス: ../bar/hoge.png データURL: data:image/png;base64,... など色々ある。 これらのフォーマットを統一して完全なURLにするのは面倒であるが、幸運にもurllib.parse.urljoinという関数があったのでこれを使う (余談: 初め、urljoinの存在を知らずに自前でURLの変換機能を実装してしまった。学びにはなったが時間を費やした…)。
ついでの機能として、「特定の要素の中に含まれているimg要素のURLを取得する」ことも考える。 これはCSSセレクタとして指定できるようにする。
まとめると、画像のURLを取得する関数は以下のようなインターフェースとなる。
def get_img_urls(url: str, selector: Optional[str]=None) -&gt; list[str]: pass # これから実装する URLとセレクタを引数にとり、img要素のURLのリストを返す関数である。
ついでに画像ダウンロードのためのCLIや、画像を閲覧するWebアプリなどが作れたら良い。
プロジェクトの構造 Pythonでモジュールを作ったことがないため、正しい作り方が分からないが、とりあえず以下のような構成にしてみる。 細かいディレクトリの構成は各節で述べる。
/project | &#43;--&#43; getimg/ | &#43;--&#43; commandline/ | &#43;--&#43; viewer/ | &#43;--&#43; tests/ &#43;-- __init__." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bombrary.github.io/blog/posts/python-get-img-url-static/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-09T11:08:15+09:00" />
<meta property="article:modified_time" content="2021-12-16T07:20:20+09:00" />


<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Pythonを使った(静的)ページの画像のURL取得"/>
<meta name="twitter:description" content="Webページの画像だけを手っ取り早く取得したい場合にどうすれば良いのかを考えた。 これを行うプログラムをPythonで取得する。
この記事で作成したプログラムはGitHubのRepositoryに公開した。
前提 Pythonのバージョンは3.10を想定。
この記事では外部ライブラリとして
Requests 2.26.0 Beautiful Soup 4.10.0 tqdm 4.62.3 w3lib 1.22.0 を使う。この記事のコードを動かす場合はpipコマンドなどでインストールしておく。
方針 やることは案外単純である。
WebページのHTMLデータを取ってくる。 img要素を探して、そのsrc属性を取ってくる。 scheme、netlocが無かったらそれを付加して、完全なURLにする。 1はRequests、2はBeautiful Soupを使えば良いだろう。 3は思ったより複雑である。src属性に入っているパスには、
URL: http://foo.org/bar/hoge.png スキームが省略されている: //foo.org/bar/hoge.png 絶対パス: /bar/hoge.png 相対パス: ../bar/hoge.png データURL: data:image/png;base64,... など色々ある。 これらのフォーマットを統一して完全なURLにするのは面倒であるが、幸運にもurllib.parse.urljoinという関数があったのでこれを使う (余談: 初め、urljoinの存在を知らずに自前でURLの変換機能を実装してしまった。学びにはなったが時間を費やした…)。
ついでの機能として、「特定の要素の中に含まれているimg要素のURLを取得する」ことも考える。 これはCSSセレクタとして指定できるようにする。
まとめると、画像のURLを取得する関数は以下のようなインターフェースとなる。
def get_img_urls(url: str, selector: Optional[str]=None) -&gt; list[str]: pass # これから実装する URLとセレクタを引数にとり、img要素のURLのリストを返す関数である。
ついでに画像ダウンロードのためのCLIや、画像を閲覧するWebアプリなどが作れたら良い。
プロジェクトの構造 Pythonでモジュールを作ったことがないため、正しい作り方が分からないが、とりあえず以下のような構成にしてみる。 細かいディレクトリの構成は各節で述べる。
/project | &#43;--&#43; getimg/ | &#43;--&#43; commandline/ | &#43;--&#43; viewer/ | &#43;--&#43; tests/ &#43;-- __init__."/>


<header>
  
    <a href="https://bombrary.github.io/blog/" class="title">Chanomic Blog</a>
  
  
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/python-get-img-url-static/">Pythonを使った(静的)ページの画像のURL取得</a></h1>
    <div class="meta">
      
      <div class="pub-date">
        <time datetime="2021-12-09T11:08:15&#43;09:00">December 09, 2021</time>
      </div>
      
      
      <div class="lastmod-date">
        <div class="lastmod-date__label">(last modified:</div>
        <time datetime="2021-12-09T11:08:15&#43;09:00">December 16, 2021</time>
        <div class="lastmod-date__label">)</div>
      </div>
      
    </div>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/cli/">CLI</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/flask/">Flask</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/web/">Web</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="categories_item"><a href="https://bombrary.github.io/blog//categories/python/">Python</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  
    <aside>
      <h2>目次</h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#前提">前提</a></li>
    <li><a href="#方針">方針</a></li>
    <li><a href="#プロジェクトの構造">プロジェクトの構造</a>
      <ul>
        <li><a href="#cli">CLI</a></li>
        <li><a href="#画像ビューワー">画像ビューワー</a></li>
        <li><a href="#補足-pyrightを使った開発">補足: pyrightを使った開発</a></li>
      </ul>
    </li>
    <li><a href="#画像のurlを取得する関数の作成">画像のURLを取得する関数の作成</a>
      <ul>
        <li><a href="#大まかな処理">大まかな処理</a></li>
        <li><a href="#img要素を探しそのパスを取得する処理">img要素を探し、そのパスを取得する処理</a></li>
        <li><a href="#テスト">テスト</a></li>
      </ul>
    </li>
    <li><a href="#cliの作成">CLIの作成</a>
      <ul>
        <li><a href="#仕様">仕様</a></li>
        <li><a href="#準備">準備</a></li>
        <li><a href="#メインとなる処理">メインとなる処理</a></li>
        <li><a href="#画像をダウンロードする処理">画像をダウンロードする処理</a></li>
        <li><a href="#パスの解決処理">パスの解決処理</a></li>
        <li><a href="#画像の保存処理">画像の保存処理</a></li>
        <li><a href="#テスト-1">テスト</a></li>
        <li><a href="#インターフェースの作成">インターフェースの作成</a></li>
      </ul>
    </li>
    <li><a href="#画像ビューワーwebアプリの作成">画像ビューワーWebアプリの作成</a>
      <ul>
        <li><a href="#仕様-1">仕様</a></li>
        <li><a href="#雛形作成">雛形作成</a></li>
        <li><a href="#templateの作成">templateの作成</a></li>
        <li><a href="#ビューの作成">ビューの作成</a></li>
        <li><a href="#画像の並びの調整">画像の並びの調整</a></li>
      </ul>
    </li>
    <li><a href="#今後の課題">今後の課題</a></li>
  </ul>
</nav>
    </aside>
    
  <p>Webページの画像だけを手っ取り早く取得したい場合にどうすれば良いのかを考えた。
これを行うプログラムをPythonで取得する。</p>
<p>この記事で作成したプログラムは<a href="https://github.com/bombrary/get-img-python">GitHubのRepository</a>に公開した。</p>
<h2 id="前提">前提</h2>
<ul>
<li>
<p>Pythonのバージョンは3.10を想定。</p>
</li>
<li>
<p>この記事では外部ライブラリとして</p>
<ul>
<li><a href="https://requests.readthedocs.io/en/master/">Requests</a> 2.26.0</li>
<li><a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">Beautiful Soup</a> 4.10.0</li>
<li><a href="https://github.com/tqdm/tqdm">tqdm</a> 4.62.3</li>
<li><a href="https://w3lib.readthedocs.io/en/latest/">w3lib</a> 1.22.0</li>
</ul>
<p>を使う。この記事のコードを動かす場合は<code>pip</code>コマンドなどでインストールしておく。</p>
</li>
</ul>
<h2 id="方針">方針</h2>
<p>やることは案外単純である。</p>
<ol>
<li>WebページのHTMLデータを取ってくる。</li>
<li><code>img</code>要素を探して、その<code>src</code>属性を取ってくる。</li>
<li>scheme、netlocが無かったらそれを付加して、完全なURLにする。</li>
</ol>
<p>1は<a href="https://requests.readthedocs.io/en/master/">Requests</a>、2は<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">Beautiful Soup</a>を使えば良いだろう。
3は思ったより複雑である。<code>src</code>属性に入っているパスには、</p>
<ul>
<li>URL: <code>http://foo.org/bar/hoge.png</code></li>
<li>スキームが省略されている: <code>//foo.org/bar/hoge.png</code></li>
<li>絶対パス: <code>/bar/hoge.png</code></li>
<li>相対パス: <code>../bar/hoge.png</code></li>
<li>データURL: <code>data:image/png;base64,...</code></li>
</ul>
<p>など色々ある。
これらのフォーマットを統一して完全なURLにするのは面倒であるが、幸運にも<a href="https://docs.python.org/ja/3/library/urllib.parse.html#urllib.parse.urljoin">urllib.parse.urljoin</a>という関数があったのでこれを使う
(余談: 初め、<code>urljoin</code>の存在を知らずに自前でURLの変換機能を実装してしまった。学びにはなったが時間を費やした…)。</p>
<p>ついでの機能として、「特定の要素の中に含まれている<code>img</code>要素のURLを取得する」ことも考える。
これはCSSセレクタとして指定できるようにする。</p>
<p>まとめると、画像のURLを取得する関数は以下のようなインターフェースとなる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span> <span class="c1"># これから実装する</span>
</span></span></code></pre></div><p>URLとセレクタを引数にとり、<code>img</code>要素のURLのリストを返す関数である。</p>
<p>ついでに画像ダウンロードのためのCLIや、画像を閲覧するWebアプリなどが作れたら良い。</p>
<h2 id="プロジェクトの構造">プロジェクトの構造</h2>
<p>Pythonでモジュールを作ったことがないため、正しい作り方が分からないが、とりあえず以下のような構成にしてみる。
細かいディレクトリの構成は各節で述べる。</p>
<pre tabindex="0"><code>/project
|
+--+ getimg/
|
+--+ commandline/
|
+--+ viewer/
|
+--+ tests/
     +-- __init__.py
     +-- test_getimg.py
     +-- test_commandline.py
</code></pre><h3 id="cli">CLI</h3>
<p>CLIの書式は以下のようにする。取得したい画像のあるページのURL、及び画像のダウンロード先を指定する。</p>
<pre class="cui">
> python -m commandline "http://foo.com/bar/" output/
</pre>

<p>CLIのコマンドライン引数の取扱いには<a href="https://docs.python.org/ja/3/library/argparse.html?highlight=add_argument#module-argparse">argparse</a>が便利なのでそれを使う。</p>
<h3 id="画像ビューワー">画像ビューワー</h3>
<p>Webアプリについては、<a href="https://flask.palletsprojects.com/en/2.0.x/">Flask</a>が一番手軽かなと思ったのでこれを使う。</p>
<p>以下のコマンドでWebサーバーが起動するようにする。</p>
<pre class="cui">
> python -m viewer
</pre>

<p>ここではとりあえず一番手軽な<code>Flask.run</code>関数でサーバーを動かす。<code>Flask.run</code>で動作するのは開発用サーバーなのだが、個人的に利用することしか考えていないのでこれで良い。</p>
<h3 id="補足-pyrightを使った開発">補足: pyrightを使った開発</h3>
<p>LSPにpyrightを使うとき、例えば<code>commandline/__init__.py</code>から<code>getimg</code>モジュールを参照しようとすると、「モジュールが無い」と怒られる。
これはプロジェクトの場所をpyrightが認識していないのが原因(多分)。なのでプロジェクトの位置をpyrightに教えてあげる必要がある。
そのために、<code>pyrightconfig.json</code>を作成し、内容を以下のようにする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;executionEnvironments&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;root&#34;</span><span class="p">:</span> <span class="s2">&#34;.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="画像のurlを取得する関数の作成">画像のURLを取得する関数の作成</h2>
<p><code>getimg</code>ディレクトリの構成。</p>
<pre tabindex="0"><code>/project
|
+-- getimg/
    +-- __init__.py
</code></pre><p><code>getimg/__init__.py</code>を編集。必要モジュールは以下の通り。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeGuard</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib.parse</span>
</span></span></code></pre></div><h3 id="大まかな処理">大まかな処理</h3>
<p>まず、画像の取得は<code>requests</code>モジュールの<code>get</code>関数を使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span></code></pre></div><p>手に入れたHTML文書から<code>img</code>要素を探し、そのパスを取得する処理は<code>get_img_srcs</code>という関数に任せる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">paths</span> <span class="o">=</span> <span class="n">get_img_srcs</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span>
</span></span></code></pre></div><p><code>get_img_srcs</code>は次のようなシグネチャとし，後で実装する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_img_srcs</span><span class="p">(</span><span class="n">html_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><p>取得したパスに対し、<code>urllib.parse.urljoin</code>関数を使ってURLに変換する。
引数に指定しているのは<code>url</code>ではなく<code>response.url</code>である。このようにすれば、リダイレクトされたケースに対応できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">[</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
</span></span></code></pre></div><p>これらをまとめると、以下のようになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">paths</span> <span class="o">=</span> <span class="n">get_img_srcs</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
</span></span></code></pre></div><h3 id="img要素を探しそのパスを取得する処理">img要素を探し、そのパスを取得する処理</h3>
<p>まずは<code>BeautifulSoup</code>でHTML文書をパースする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><code>soup.select</code>を使って<code>img</code>要素を探す。その際、引数<code>selector</code>が指定されていれば<code>soup.select('[selector] img')</code>
とし、指定されていなければ<code>soup.select('img')</code>とする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">new_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s1"> img&#39;</span> <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;img&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">imgs</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">new_selector</span><span class="p">)</span>
</span></span></code></pre></div><p><code>get</code>メソッドで<code>src</code>要素を読み取り、パスを取得する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">]</span>
</span></span></code></pre></div><p>型を気にしないのであればこのまま<code>return paths</code>しても良いが、pyrightなりmypyなりの型チェックをした際に怒られる。
これはなぜかというと、<code>bs4</code>モジュールの<code>Tag.get</code>関数の返り値が<code>str | list[str] | None</code>であるから。
これはコード中の<code>img.get('src')</code>に対応している。<code>img</code>要素なのに属性値が無かったり複数値とったりすることなんで普通は無いのだが、<code>Tag</code>の実装上こうなってしまっている。</p>
<p>解決策は、以下のように<code>TypeGuard</code>を使って、リストの中に<code>str</code>型のものしかないことを保証してやる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_attr_str</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">is_attr_str</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
</span></span></code></pre></div><p>ここまでをまとめると、関数は以下のようになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_attr_str</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_img_srcs</span><span class="p">(</span><span class="n">html_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s1"> img&#39;</span> <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;img&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">imgs</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">new_selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">is_attr_str</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
</span></span></code></pre></div><h3 id="テスト">テスト</h3>
<p><code>tests/test_getimg.py</code>を編集。pytestを使ってテストを書く</p>
<p><code>getimg/tests/test_getimg.py</code>の内容を以下のようにする。
<code>get_img_srcs</code>関数と<code>get_img_urls</code>関数のテストをここで行う。</p>
<p>まずはテストの対象であるHTML文書を書いておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">getimg</span> <span class="kn">import</span> <span class="n">get_img_srcs</span><span class="p">,</span> <span class="n">get_img_urls</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">MonkeyPatch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">html_text</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;div class=&#34;container1&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;img src=&#34;http://loc1.com/foo/img1.png&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;img src=&#34;/img2.png&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;div class=&#34;container2&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;img src=&#34;../img3.png&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;img src=&#34;//loc2.com/img4.png&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;img src=&#34;data:image/png;base64,BINIMAGE&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;/body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p><code>get_src</code>関数がうまくいくかどうかのテスト。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_get_src</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">expect</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc1.com/foo/img1.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/img2.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;../img3.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;//loc2.com/img4.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;data:image/png;base64,BINIMAGE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">get_img_srcs</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span></code></pre></div><p><code>get_img_urls</code>関数がうまくいくかどうかのテスト。pytestの<code>monkeypatch</code> fixtureを使い、<code>requests.get</code>の処理を<code>fake_get</code>に挿げ替えているところがポイント。
CSSセレクタが機能しているかどうかのテストも行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">html_text</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fake_get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_get_url</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">:</span> <span class="n">MonkeyPatch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;requests.get&#39;</span><span class="p">,</span> <span class="n">fake_get</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://loc.com/foo/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">expect</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc1.com/foo/img1.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc.com/img2.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc.com/img3.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc2.com/img4.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;data:image/png;base64,BINIMAGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_get_url_with_selector</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">:</span> <span class="n">MonkeyPatch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;requests.get&#39;</span><span class="p">,</span> <span class="n">fake_get</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://loc.com/foo/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">expect</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc.com/img3.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http://loc2.com/img4.png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;data:image/png;base64,BINIMAGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&#34;.container2&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span></code></pre></div><p>これで<code>pytest</code>を実行すると、テストに成功することが確かめられる。</p>
<h2 id="cliの作成">CLIの作成</h2>
<h3 id="仕様">仕様</h3>
<p><code>commandline</code>ディレクトリの構成。</p>
<pre tabindex="0"><code>/project
|
+-- commandline/
    +-- __init__.py
    +-- __main__.py
</code></pre><p>CLIの機能及び実装上の注意については以下の通り。</p>
<ul>
<li>
<p>重複している名前があれば、ファイル名の末尾に<code>_1</code>、<code>_2</code>などと数字をつける。</p>
</li>
<li>
<p>画像のダウンロードに失敗した場合、そのURLと失敗の原因を出力する。</p>
</li>
<li>
<p>プログレスバーを出力する。</p>
</li>
<li>
<p>クエリ文字列に注意する。<code>http://foo.com/img.png?foobar</code>みたいにクエリ文字列がついていることがある。</p>
</li>
<li>
<p>Data URLの場合で処理を分ける必要がある。URLの中に画像データが含まれているため、以下の3つの事項に注意する。</p>
<ul>
<li>Data URLをパースして、画像データ、画像の形式のデータを取得する必要がある。</li>
<li>画像データをデコードする場合、エンコーディング形式に気をつける必要がある。<code>png</code>などのバイナリ形式の画像なら<code>base64</code>であるが、<code>svg</code>形式の場合は<code>utf-8</code>の可能性がある。</li>
<li>画像ファイル名が存在しないため、適当に<code>data_url.png</code>という名前をつけることにする。</li>
</ul>
<p>パース処理、デコード処理が結構面倒。しかし幸運にも<a href="https://w3lib.readthedocs.io/en/latest/">w3lib</a>というライブラリの<code>w3lib.url.parse_data_uri</code>と言う関数があったので使わせてもらう。</p>
</li>
<li>
<p>テストがしやすいように、処理を細かく関数に分ける。</p>
</li>
</ul>
<p>また、実行するときは以下のような書式にする。</p>
<pre class="cui">
> python -m commandline "http://foo.com/bar/" output/
</pre>

<p>また、コマンドライン引数を指定できるようにする。</p>
<ul>
<li><code>-v</code>オプションをつけると、ダウンロードした画像URLとその出力先のログを出力。</li>
<li><code>-s</code>オプションをつけると、CSSセレクターを指定できる。</li>
</ul>
<h3 id="準備">準備</h3>
<p><code>commandline/__init__.py</code>を編集。まず、必要モジュールをインポート。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">getimg</span> <span class="kn">import</span> <span class="n">get_img_urls</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">RequestException</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib.parse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os.path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span></code></pre></div><p>ログを出力する関数を作っておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_log</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">need_log</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">need_log</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="メインとなる処理">メインとなる処理</h3>
<p>URLからHTML文書を取得し、そこから<code>img</code>タグの<code>src</code>を読み取り、そのダウンロードを行う関数は<code>download_imgs_from_page</code>とする。
返り値は画像のダウンロードの失敗情報のリストである。これは<code>(URL, 例外)</code>のタプルのリストとする。</p>
<p><code>download_imgs_from_urls</code>は次の項で実装する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">FailInfo</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RequestException</span> <span class="o">|</span> <span class="ne">ValueError</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_imgs_from_page</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">need_log</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FailInfo</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">urls</span> <span class="o">=</span> <span class="n">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">download_imgs_from_urls</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">need_log</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="画像をダウンロードする処理">画像をダウンロードする処理</h3>
<p>1つの画像をダウンロードする処理、複数の画像をダウンロードする処理を別々の関数に分ける。
例外が発生した場合は、その結果を<code>failInfo</code>に入れる。Data URLか否かの分岐はここで行っている。</p>
<p>プログレスバーを出力するのには<a href="https://github.com/tqdm/tqdm">tqdm</a>を使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_dataurl</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_imgs_from_urls</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">need_log</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FailInfo</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">failInfo</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">urls</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_dataurl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span> <span class="o">=</span> <span class="n">save_img_from_data_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">need_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">failInfo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="c1"># 長すぎる場合が多いので100文字までで切る</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span> <span class="o">=</span> <span class="n">download_img_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">need_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">failInfo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">failInfo</span>
</span></span></code></pre></div><p>データURLでないURLについては、普通に<code>requests.get</code>関数でダウンロードする。
<code>make_path</code>関数と<code>save_img</code>関数はこの後実装する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_img_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">need_log</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestException</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">make_path</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">save_img</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">print_log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">need_log</span><span class="p">)</span>
</span></span></code></pre></div><p>続いてデータURL形式の処理。主なパース処理は<code>w3lib.url.parse_data_uri</code>に任せ、拡張子は<code>extract_ext_from_mime</code>という関数を作って処理している。
<code>svg</code>形式の画像についてはMIMEタイプが<code>image/svg+xml</code>となるため、例外的に扱っている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_ext_from_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svg+xml&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;svg&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">type</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_img_from_data_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">need_log</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">ValueError</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">w3lib</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">parse_data_uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ext</span> <span class="o">=</span> <span class="n">extract_ext_from_mime</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/dara_url.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_img</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">print_log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(Data URL) -&gt; </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">need_log</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="パスの解決処理">パスの解決処理</h3>
<p>与えられた画像のURLからファイル名を取り出して、画像を出力するディレクトリ<code>output_dir</code>と組み合わせて保存先パスを作成。</p>
<p><code>output_dir</code>について、<code>dir/</code>と<code>dir</code>は同じものとみなす。そのために<code>rstrip</code>関数を用いている。
別にこれをしなくても保存自体はできるのだが、ログに<code>http://foo.com/img.png -&gt; output_dir//img.png</code>と二重の<code>//</code>が現れてしまい、少し汚い。</p>
<p><code>urllib.parse.urlparse</code>をわざわざ呼び出しているのは、クエリ文字列を省くため。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_path</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">extract_filename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_filename</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">urlinfo</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlinfo</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="画像の保存処理">画像の保存処理</h3>
<p><code>rename_if_exists</code>関数で行っている処理は、出力先パスに同名のファイルが無いかどうか調べ、存在した場合は<code>name_1.png</code>や<code>name_2.png</code>のように数字をつけること。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_img</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">rename_if_exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rename_if_exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">new_path</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span></code></pre></div><h3 id="テスト-1">テスト</h3>
<p><code>tests/test_commandline.py</code>を編集。使う関数を読み込んでおく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">commandline</span> <span class="kn">import</span> <span class="n">extract_filename</span><span class="p">,</span> <span class="n">make_path</span><span class="p">,</span> <span class="n">rename_if_exists</span><span class="p">,</span> <span class="n">download_imgs_from_urls</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pytest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">MonkeyPatch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
</span></span></code></pre></div><p>関数<code>extract_filename</code>のテスト。クエリ文字列がちゃんと省かれるかどうか見ている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">test_cases_extract_filename</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/bar/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/bar/img.png?q=123&#34;</span><span class="p">,</span> <span class="s2">&#34;img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;url, expect&#34;</span><span class="p">,</span> <span class="n">test_cases_extract_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_extract_filename</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">extract_filename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span></code></pre></div><p>関数<code>make_path</code>のテスト。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">test_cases_make_path</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout/img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout/&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout/img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;http://foo.com/bar/fuga/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout&#34;</span><span class="p">,</span> <span class="s2">&#34;imgout/img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;url, output_dir, expect&#34;</span><span class="p">,</span> <span class="n">test_cases_make_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_make_path</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">make_path</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span></code></pre></div><p>関数<code>rename_if_exists</code>のテスト。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">test_cases_rename_if_exists</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="s2">&#34;output/img.png&#34;</span><span class="p">],</span> <span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_1.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_1.png&#34;</span><span class="p">],</span> <span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_2.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="s2">&#34;output/img_1.png&#34;</span><span class="p">],</span> <span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="s2">&#34;output/img_1.png&#34;</span><span class="p">],</span> <span class="s2">&#34;output/img_1.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_1_1.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_2.png&#34;</span><span class="p">],</span> <span class="s2">&#34;output/img.png&#34;</span><span class="p">,</span> <span class="s2">&#34;output/img_1.png&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&#34;paths_exist, target, expect&#34;</span><span class="p">,</span> <span class="n">test_cases_rename_if_exists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_rename_if_exists</span><span class="p">(</span><span class="n">paths_exist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">:</span> <span class="n">MonkeyPatch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fake_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths_exist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;os.path.exists&#39;</span><span class="p">,</span> <span class="n">fake_exists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">rename_if_exists</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="n">expect</span>
</span></span></code></pre></div><p>関数<code>download_imgs_from_urls</code>のテスト。失敗した場合にその情報を返すかどうかを見ている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_download_imgs_from_urls</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">:</span> <span class="n">MonkeyPatch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fake_save_img</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;succeed&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fake_get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">HTTPError</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;commandline.save_img&#39;</span><span class="p">,</span> <span class="n">fake_save_img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;requests.get&#39;</span><span class="p">,</span> <span class="n">fake_get</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;fail&#34;</span><span class="p">,</span> <span class="s2">&#34;success&#34;</span><span class="p">,</span> <span class="s2">&#34;fail&#34;</span><span class="p">,</span> <span class="s2">&#34;fail&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">failInfo</span> <span class="o">=</span> <span class="n">download_imgs_from_urls</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">failInfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</span></span></code></pre></div><p>これで<code>pytest</code>が通ることを確認する。</p>
<h3 id="インターフェースの作成">インターフェースの作成</h3>
<p><code>__main__.py</code>を編集。<code>argparse</code>モジュールを使って、コマンドライン引数のパースを行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">download_imgs_from_page</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&#34;commandline&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;print log verbosely&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;CSS selector&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">failInfo</span> <span class="o">=</span> <span class="n">download_imgs_from_page</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">failInfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span></code></pre></div><p>これで<code>python -m commandline URL 出力先ディレクトリ</code>とすると画像がダウンロードされるはず。
<code>python -m commandline -h</code>とするとコマンドの説明が出力される。</p>
<h2 id="画像ビューワーwebアプリの作成">画像ビューワーWebアプリの作成</h2>
<h3 id="仕様-1">仕様</h3>
<p><code>viewer</code>ディレクトリの構成。</p>
<pre tabindex="0"><code>/project
|
+-- viewer/
    +-- __init__.py
    +-- __main__.py
    +-- templates/
    |   +-- index.html
    +-- static/
        +-- style.css
</code></pre><p>以下のような仕様を持つアプリを作る。</p>
<ul>
<li><code>/</code>にアクセスすると、URLとCSSセレクタを入力するフォームが現れる。URLは必須入力。</li>
<li>送信ボタンを押すと、入力したURLにある画像をそのページに表示する。</li>
</ul>
<h3 id="雛形作成">雛形作成</h3>
<p><code>__init__.py</code>を以下のようにする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hello&#39;</span>
</span></span></code></pre></div><p><code>__main__.py</code>を以下のようにする。一応、<code>-p [port]</code>でポートを指定できるようにしておく。</p>
<p>デバックのしやすさのため、<code>app.config['ENV'] = 'development'</code>を指定しておく
(本番環境の場合は使ってはいけないので注意。<a href="https://msiz07-flask-docs-ja.readthedocs.io/ja/latest/config.html#ENV">参考</a>)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">viewer</span> <span class="kn">import</span> <span class="n">app</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&#34;viewer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&#34;8000&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ENV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;development&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
</span></span></code></pre></div><p>これで<code>python -m viewer</code>とすると、開発用サーバーが起動する。ポートを変えたい場合は<code>python -m viewer -p ポート番号</code>とする。以下、ポートはデフォルトの<code>8000</code>で話を進める。<a href="http://localhost:8000">http://localhost:8000</a>にアクセスすると、現時点では<code>Hello</code>とだけ表示されたページが出力される。</p>
<h3 id="templateの作成">templateの作成</h3>
<p>仕様的に、作るWebページは1ページだけでよい。それを<code>viewer/templates/index.html</code>とし、以下のようにする。</p>
<p>CSSを後で書くので、適当にクラスを付与しておく。
<code>.get-img-form</code>の中にあるのが入力フォーム、<code>.received-images</code>の中にあるのが、表示された画像を表す。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Image Viewer<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;{{ url_for(&#39;static&#39;, filename=&#39;style.css&#39;) }}&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;get-img-form&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;url&#34;</span><span class="p">&gt;</span>URL<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;url&#34;</span> <span class="na">required</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;selector&#34;</span><span class="p">&gt;</span>Selector<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;selector&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;submit&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;received-images&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      {% for url in urls %}
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;{{ url }}&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      {% endfor %}
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><h3 id="ビューの作成">ビューの作成</h3>
<p><code>viewer/__init__.py</code>を編集。今回作るFlaskアプリはこれだけでよい。</p>
<p><code>POST</code>メソッドが来たとき、フォームからURLとセレクタの情報を取得。
それを使って<code>get_img_urls</code>を呼び出し、画像URLを取得。
それを<code>render_template</code>の引数に指定すればよい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">getimg</span> <span class="kn">import</span> <span class="n">get_img_urls</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">selector</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">urls</span> <span class="o">=</span> <span class="n">get_img_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">urls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>こんな感じのページが表示される。ここにURLとセレクタ(任意)を入力しsubmitボタンを押すと、URL先の画像が下に表示される。</p>
<figure><img src="img/sc0.png"/>
</figure>

<h3 id="画像の並びの調整">画像の並びの調整</h3>
<p>このままだと画像の並びがやや汚いため、<code>getimg/viewer/static/style.css</code>を編集。<code>columns</code>プロパティを利用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="p">.</span><span class="nc">received-images</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">columns</span><span class="p">:</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">received-images</span> <span class="nt">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>これで最低限のWebアプリができた。</p>
<h2 id="今後の課題">今後の課題</h2>
<ul>
<li>Webアプリのデザインを最低限しかやっていないので、もう少しCSSを書くべき。</li>
<li>JSなどを使っている動的なページの画像取得ができない。そのため割と多くのWebサイトにおいて、画像が取得できない。これは<code>request.get</code>の代わりにSeleniumを使えば対応できるかも。その場合、「画像が読み込まれるまで数秒待つ」「特定の要素が現れるまで待つ」などといった処理が必要になるため、今回作った<code>getimg</code>モジュールよりは複雑になる。</li>
</ul>

</article>



</html>
