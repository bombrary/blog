<!DOCTYPE html>
<html lang="ja-jp">
<title>iPhoneアプリ開発メモ - 棒グラフの作成(UIKit/CoreGraphics) (2) | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.64.1" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>



<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/iphone-barchart-cg02/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/theme.css">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/classes.css">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/syntax.css">


<header class="dark">
  <h2><a href="https://bombrary.github.io/blog/">Chanomic Blog</a></h2>
  <nav>
    
  </nav>
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/iphone-barchart-cg02/">iPhoneアプリ開発メモ - 棒グラフの作成(UIKit/CoreGraphics) (2)</a></h1>
    <p class="meta"><time datetime="2019-12-22T15:10:30&#43;09:00">December 22, 2019</time></p>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/swift/">Swift</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/iphone/">iPhone</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/uikit/">UIKit</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/coregraphics/">CoreGraphics</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/uiscrollview/">UIScrollView</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/%e6%a3%92%e3%82%b0%e3%83%a9%e3%83%95/">棒グラフ</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/visualization/">Visualization</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="tags_item"><a href="https://bombrary.github.io/blog//categories/swift/">Swift</a></li> <li class="tags_item"><a href="https://bombrary.github.io/blog//categories/iphone/">iPhone</a></li> <li class="tags_item"><a href="https://bombrary.github.io/blog//categories/visualization/">Visualization</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  <h2 id="目標">目標</h2>
<ul>
<li>前回の棒グラフを複数ページにする
<ul>
<li>今回は、1ページに最大5本の棒が並ぶ、とする。</li>
</ul>
</li>
<li>ページは横スライドで切り替える</li>
</ul>
<p>プロジェクトは前回のものを引き継がず、新しく作る。</p>
<h2 id="用いるデータ">用いるデータ</h2>
<p><code>ViewController.swift</code>が次のようなデータを持っていることを想定する。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">var</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">太郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">次郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">三郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">四郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">五郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">六郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">七郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">八郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">九郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十一郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十二郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十三郎</span><span class="s">&#34;</span><span class="p">)</span>
<span class="p">]</span></code></pre></div>
<p>このデータは、後で整形してグラフ描画用のデータに変換する。</p>
<h2 id="uscrollviewの配置">UScrollViewの配置</h2>
<p><code>Main.storyboard</code>にUIScrollViewを配置する。サイズ設定はコードで行うので、ここでは単に配置するだけ。</p>
<figure>
    <img src="./storyboard_main01.png" width="50%"/> 
</figure>

<p>その後、UIScrollViewのOutlet接続を<code>ViewController.swift</code>に対して行う。</p>
<h2 id="uiscrollvieの設定">UIScrollVieの設定</h2>
<p>「スクロールの対象となるコンテンツを中に入れる」だけで、スクロール可能なViewが作れる。ただし、思い通りの表示にするためには、UIScrollViewやコンテンツのサイズを設定しておく必要がある。</p>
<p>複数ページを持つコンテンツを作りたいので、コンテンツ用Viewの中にページ用のViewが複数存在する状態になる。なのでページの位置やサイズもちゃんと設定する。</p>
<h3 id="scrollviewのレイアウト">ScrollViewのレイアウト</h3>
<p>こんな感じにする。</p>
<figure>
    <img src="./layout_scrollView01.svg" width="50%"/> 
</figure>

<p>なのでコードはこんな感じにする。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>

    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">scrollView</span><span class="p">:</span> <span class="n">UIScrollView</span><span class="p">!</span>
    <span class="kd">let</span> <span class="nv">marginX</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">80</span>
    <span class="kd">let</span> <span class="nv">marginY</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">40</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">(</span><span class="p">)</span>
        <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">marginX</span><span class="p">,</span>
            <span class="n">y</span><span class="p">:</span> <span class="n">marginY</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">marginX</span><span class="p">,</span>
            <span class="n">height</span><span class="p">:</span> <span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">marginY</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="contentsviewのレイアウト">contentsViewのレイアウト</h3>
<p>例えばページが5枚だとすると、ページ5枚で1つのcontentsViewを作る。それを念頭においてレイアウトを組む必要がある。</p>
<figure>
    <img src="./layout_scrollView02.svg" width="70%"/> 
</figure>

<h3 id="ダミー用graphview作成">ダミー用GraphView作成</h3>
<p>GraphViewに関する位置、サイズの設定は、イニシャライザに任せるように書く。引数として、<code>(ページ番号, スクロールビューのサイズ, データ)</code>を与える。とりあえず今の所はデータを色として、これを<code>backgroundColor</code>に設定する。</p>
<p>上のレイアウトから、i番目のページのx座標は<code>i * size.width</code>で与えられることが分かる。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">GraphView</span><span class="p">:</span> <span class="n">UIView</span> <span class="p">{</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">CGSize</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">UIColor</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">color</span>
        <span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="p">:</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span>
        <span class="p">)</span>
        
    <span class="p">}</span>
    <span class="kr">required</span> <span class="kd">init</span><span class="p">?</span><span class="p">(</span><span class="n">coder</span><span class="p">:</span> <span class="n">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;</span><span class="s">init(coder:) has not been implemented</span><span class="s">&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">draw</span><span class="p">(</span><span class="kc">_</span> <span class="n">rect</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h2 id="viecontrollerswift">VieController.swift</h2>
<p>ページ数とデータを定数として定義する。contentsViewを作る処理は関数に分けておく。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="n">UIColor</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span><span class="p">.</span><span class="n">systemRed</span><span class="p">,</span> <span class="p">.</span><span class="n">systemIndigo</span><span class="p">,</span> <span class="p">.</span><span class="n">systemPink</span><span class="p">,</span> <span class="p">.</span><span class="n">systemGreen</span><span class="p">]</span>
<span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">numOfPages</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="bp">count</span>
<span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">scrollView</span><span class="p">:</span> <span class="n">UIScrollView</span><span class="p">!</span>
  <span class="p">.</span><span class="p">.</span><span class="p">.</span>
  <span class="kd">let</span> <span class="nv">contentsView</span> <span class="p">=</span> <span class="n">createContentsView</span><span class="p">(</span><span class="p">)</span>
  <span class="n">scrollView</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">contentsView</span><span class="p">)</span>
  <span class="n">scrollView</span><span class="p">.</span><span class="n">contentSize</span> <span class="p">=</span> <span class="n">contentsView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span>
<span class="p">}</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">createContentsView</span><span class="p">(</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UIView</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">contentsView</span> <span class="p">=</span> <span class="n">UIView</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">numOfPages</span><span class="p">)</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">height</span>
    <span class="p">)</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">datum</span><span class="p">)</span> <span class="k">in</span> <span class="n">data</span><span class="p">.</span><span class="n">enumerated</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">pageView</span> <span class="p">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">datum</span><span class="p">)</span>
        <span class="n">contentsView</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">pageView</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">contentsView</span>
<span class="p">}</span></code></pre></div>
<p>この時点でアプリを起動してみると、次のようになる。よく見ると下にスクロールバーが付いている。</p>
<figure>
    <img src="./mov01.gif" width="30%"/> 
</figure>

<h2 id="ユーティリティ関数メソッドの定義">ユーティリティ関数/メソッドの定義</h2>
<p><code>Util.swift</code>を作成して、以下の記述を追加する。これは前回お世話になったscaleLinear関数。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>

<span class="c1">//</span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1">r</span><span class="c1">a</span><span class="c1">n</span><span class="c1">[</span><span class="c1">1</span><span class="c1">]</span><span class="c1"> </span><span class="c1">-</span><span class="c1"> </span><span class="c1">r</span><span class="c1">a</span><span class="c1">n</span><span class="c1">[</span><span class="c1">0</span><span class="c1">]</span>
<span class="c1">//</span><span class="c1"> </span><span class="c1">f</span><span class="c1">(</span><span class="c1">x</span><span class="c1">)</span><span class="c1"> </span><span class="c1">=</span><span class="c1"> </span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1">-</span><span class="c1"> </span><span class="c1">*</span><span class="c1"> </span><span class="c1">(</span><span class="c1">x</span><span class="c1"> </span><span class="c1">-</span><span class="c1"> </span><span class="c1">d</span><span class="c1">o</span><span class="c1">m</span><span class="c1">[</span><span class="c1">0</span><span class="c1">]</span><span class="c1">)</span><span class="c1"> </span><span class="c1">+</span><span class="c1"> </span><span class="c1">r</span><span class="c1">a</span><span class="c1">n</span><span class="c1">[</span><span class="c1">0</span><span class="c1">]</span>
<span class="c1">//</span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1"> </span><span class="c1">d</span><span class="c1">o</span><span class="c1">m</span><span class="c1">[</span><span class="c1">1</span><span class="c1">]</span><span class="c1"> </span><span class="c1">-</span><span class="c1"> </span><span class="c1">d</span><span class="c1">o</span><span class="c1">m</span><span class="c1">[</span><span class="c1">0</span><span class="c1">]</span>
<span class="kd">func</span> <span class="nf">scaleLinear</span><span class="p">(</span><span class="n">domain</span> <span class="n">dom</span> <span class="p">:</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">,</span> <span class="n">CGFloat</span><span class="p">)</span><span class="p">,</span> <span class="n">range</span> <span class="n">ran</span><span class="p">:</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">,</span> <span class="n">CGFloat</span><span class="p">)</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span> <span class="k">in</span>
        <span class="p">(</span><span class="n">ran</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ran</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dom</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dom</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">dom</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">ran</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>続いて、以下の記述を追加する。これは<code>Array</code>のextensionで、ある配列をk個単位に分割するときに用いる。例えば、<code>[1,2,3,4,5,6,7,8].chunked(into: 3)</code>とすると、<code>[[1,2,3],[4,5,6],[7.8]]</code>が返ってくる。</p>
<p>ちなみにこのメソッド定義は<a href="https://www.hackingwithswift.com/example-code/language/how-to-split-an-array-into-chunks">こちら</a>のもの。<code>stride</code>を使ってうまく書けている。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">extension</span> <span class="nc">Array</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">chunked</span><span class="p">(</span><span class="n">into</span> <span class="n">size</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="bp">stride</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="bp">count</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="n">size</span><span class="p">)</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
            <span class="nb">Array</span><span class="p">(</span><span class="kc">self</span><span class="p">[</span><span class="nv">$0</span> <span class="p">.</span><span class="p">.</span><span class="o">&lt;</span> <span class="n">Swift</span><span class="p">.</span><span class="bp">min</span><span class="p">(</span><span class="nv">$0</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="bp">count</span><span class="p">)</span><span class="p">]</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h2 id="棒グラフのレイアウト">棒グラフのレイアウト</h2>
<p>前回と少し変えて次のようにする。</p>
<figure>
    <img src="./layout_graphview01.svg" width="70%"/> 
</figure>

<p>Barの番号は0から数えるものとする。なのでx座標用のscaleLinearを定義するときにdomainを<code>(0, numOfBars-1)</code>にする。前回はこの辺りの記述をあまり考えずやっていたので、x座標が若干ずれていたかもしれない。</p>
<p>padXは画面両端の余白と定義する。barWidthは固定長として定義し、Barの間隔は前回の<code>xScale</code>によって勝手に設定されるので考えない。</p>
<h3 id="グラフ描画情報を持つクラスの作成">グラフ描画情報を持つクラスの作成</h3>
<p>グラフの大きさやscale関数、テキストの大きさやフォントなどの設定はクラスとしてまとめておく。</p>
<p>新たに<code>BarChart.swift</code>を作成し、内容を以下のようにする。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">BarChartScale</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">x</span><span class="p">:</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span>
    <span class="kd">var</span> <span class="nv">y</span><span class="p">:</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span>
    <span class="kd">var</span> <span class="nv">h</span><span class="p">:</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">BarChartTextOption</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">font</span><span class="p">:</span> <span class="n">UIFont</span>
    <span class="kd">var</span> <span class="nv">textStyle</span><span class="p">:</span> <span class="n">NSMutableParagraphStyle</span>
    <span class="kd">var</span> <span class="nv">foregroundColor</span><span class="p">:</span> <span class="n">UIColor</span>
    <span class="kd">var</span> <span class="nv">textFontAttributes</span><span class="p">:</span> <span class="p">[</span><span class="n">NSAttributedString</span><span class="p">.</span><span class="n">Key</span> <span class="p">:</span> <span class="n">NSObject</span><span class="p">]</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">textFontAttributes</span> <span class="p">=</span> <span class="p">[</span><span class="n">NSAttributedString</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="n">font</span><span class="p">:</span> <span class="n">font</span><span class="p">,</span>
                                  <span class="n">NSAttributedString</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="n">paragraphStyle</span><span class="p">:</span> <span class="n">textStyle</span><span class="p">,</span>
                                  <span class="n">NSAttributedString</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="n">foregroundColor</span><span class="p">:</span> <span class="n">foregroundColor</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">textFontAttributes</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">textWidth</span><span class="p">:</span> <span class="n">CGFloat</span>
    <span class="kd">var</span> <span class="nv">textHeight</span><span class="p">:</span> <span class="n">CGFloat</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">BarChartConfig</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">barsArea</span><span class="p">:</span> <span class="n">CGRect</span>
    <span class="kd">var</span> <span class="nv">numOfBars</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">barWidth</span><span class="p">:</span> <span class="n">CGFloat</span>
    <span class="kd">var</span> <span class="nv">textOption</span><span class="p">:</span> <span class="n">BarChartTextOption</span>
    <span class="kd">var</span> <span class="nv">scale</span><span class="p">:</span> <span class="n">BarChartScale</span>
<span class="p">}</span></code></pre></div>
<h3 id="グラフのレイアウト設定">グラフのレイアウト設定</h3>
<p>先ほど作った<code>BarChartConfig</code>をインスタンス化して、グラフ描画の情報を設定する。</p>
<p><code>ViewController</code>の先頭に以下の記述を追加する。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">barChartConf</span> <span class="p">=</span> <span class="n">configureBarChart</span><span class="p">(</span><span class="p">)</span></code></pre></div>
<p>さらにクラス内に以下のメソッドを追加する。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kd">func</span> <span class="nf">configureBarChart</span><span class="p">(</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">BarChartConfig</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numOfBars</span> <span class="p">=</span> <span class="mi">5</span>
    <span class="kd">let</span> <span class="nv">rect</span> <span class="p">=</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span>
    <span class="kd">let</span> <span class="nv">barWidth</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">40</span>
    <span class="kd">let</span> <span class="nv">padX</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">20</span>
    <span class="kd">let</span> <span class="nv">padY</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="kd">let</span> <span class="nv">textAreaHeight</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">70</span>
    <span class="kd">let</span> <span class="nv">barsArea</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">padX</span> <span class="o">+</span> <span class="n">barWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">padY</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">padX</span> <span class="o">+</span> <span class="n">barWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">padY</span> <span class="o">+</span> <span class="n">textAreaHeight</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="kd">let</span> <span class="nv">maxVal</span> <span class="p">=</span> <span class="n">dataSource</span><span class="p">.</span><span class="bp">max</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="p">.</span><span class="mi">0</span> <span class="p">}</span><span class="p">)</span><span class="p">?</span><span class="p">.</span><span class="mi">0</span> <span class="p">?</span><span class="p">?</span> <span class="o">-</span><span class="mi">1</span>
    <span class="kd">let</span> <span class="nv">scale</span> <span class="p">=</span> <span class="n">BarChartScale</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">scaleLinear</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">numOfBars</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="p">(</span><span class="n">barsArea</span><span class="p">.</span><span class="n">minX</span><span class="p">,</span> <span class="n">barsArea</span><span class="p">.</span><span class="n">maxX</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">scaleLinear</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">maxVal</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="p">(</span><span class="n">barsArea</span><span class="p">.</span><span class="n">maxY</span><span class="p">,</span> <span class="n">barsArea</span><span class="p">.</span><span class="n">minY</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
        <span class="n">h</span><span class="p">:</span> <span class="n">scaleLinear</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">maxVal</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">barsArea</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="kd">let</span> <span class="nv">textStyle</span> <span class="p">=</span> <span class="n">NSMutableParagraphStyle</span><span class="p">(</span><span class="p">)</span>
    <span class="n">textStyle</span><span class="p">.</span><span class="n">alignment</span> <span class="p">=</span> <span class="p">.</span><span class="n">center</span>
    <span class="kd">let</span> <span class="nv">textOption</span> <span class="p">=</span> <span class="n">BarChartTextOption</span><span class="p">(</span>
        <span class="n">font</span><span class="p">:</span> <span class="p">.</span><span class="n">systemFont</span><span class="p">(</span><span class="n">ofSize</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span><span class="p">,</span>
        <span class="n">textStyle</span><span class="p">:</span> <span class="n">textStyle</span><span class="p">,</span>
        <span class="n">foregroundColor</span><span class="p">:</span> <span class="p">.</span><span class="n">gray</span><span class="p">,</span>
        <span class="n">textWidth</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
        <span class="n">textHeight</span><span class="p">:</span> <span class="mi">30</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">BarChartConfig</span><span class="p">(</span>
        <span class="n">barsArea</span><span class="p">:</span> <span class="n">barsArea</span><span class="p">,</span>
        <span class="n">numOfBars</span><span class="p">:</span> <span class="n">numOfBars</span><span class="p">,</span>
        <span class="n">barWidth</span><span class="p">:</span> <span class="n">barWidth</span><span class="p">,</span>
        <span class="n">textOption</span><span class="p">:</span> <span class="n">textOption</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">scale</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h2 id="データの整形">データの整形</h2>
<h3 id="barchartmodel">BarChartModel</h3>
<p>棒グラフに必要なデータを定義したモデルを定義する。前回は最大値の棒だけ色をオレンジにしていたが、今回はそれをもっと抽象化し、色をモデルに含めることにする。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">BarChartModel</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">value</span><span class="p">:</span> <span class="n">CGFloat</span>
  <span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>
  <span class="kd">var</span> <span class="nv">color</span><span class="p">:</span> <span class="n">UIColor</span>
    <span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">src</span><span class="p">:</span> <span class="p">(</span><span class="nb">Int</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">UIColor</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">src</span><span class="p">.</span><span class="mi">1</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">color</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="dataの変更とdatasourceの定義">dataの変更とdataSourceの定義</h3>
<p>先ほど定義していた<code>data: [UIColor]</code>は消す。代わりに以下のようにする。<code>data</code>は二次元配列であることに注意。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">var</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">太郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">次郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">三郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">四郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">五郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">六郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">七郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">八郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">九郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十一郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十二郎</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#34;</span><span class="s">十三郎</span><span class="s">&#34;</span><span class="p">)</span>
<span class="p">]</span>
<span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="p">[</span><span class="n">BarChartModel</span><span class="p">]</span><span class="p">]</span> <span class="p">=</span> <span class="n">format</span><span class="p">(</span><span class="n">dataSource</span><span class="p">)</span></code></pre></div>
<h3 id="datasourceの整形">dataSourceの整形</h3>
<p>次のメソッドを追加する。これは<code>dataSource</code>を<code>BarChartModel</code>の形式に変換し、<code>numOfBars</code>個ずつに区切った配列を返す。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kd">func</span> <span class="nf">format</span><span class="p">(</span><span class="kc">_</span> <span class="n">data</span><span class="p">:</span> <span class="p">[</span><span class="p">(</span><span class="nb">Int</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span><span class="p">]</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="p">[</span><span class="n">BarChartModel</span><span class="p">]</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">maxDatum</span> <span class="p">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="bp">max</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="p">.</span><span class="mi">0</span> <span class="p">}</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">Failed to get max.</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nv">barChartData</span><span class="p">:</span> <span class="p">[</span><span class="n">BarChartModel</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nv">$0</span><span class="p">.</span><span class="mi">0</span> <span class="p">=</span><span class="p">=</span> <span class="n">maxDatum</span><span class="p">.</span><span class="mi">0</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">BarChartModel</span><span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="p">.</span><span class="n">systemOrange</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">BarChartModel</span><span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="p">.</span><span class="n">systemBlue</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">barChartData</span><span class="p">.</span><span class="n">chunked</span><span class="p">(</span><span class="n">into</span><span class="p">:</span> <span class="n">barChartConf</span><span class="p">.</span><span class="n">numOfBars</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h3 id="graphviewswiftの修正">GraphView.swiftの修正</h3>
<p><code>init</code>の引数を修正し、<code>backgroundColor</code>は<code>.white</code>で固定にする。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">init</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">CGSize</span><span class="p">,</span> <span class="n">barChartConf</span><span class="p">:</span> <span class="n">BarChartConfig</span><span class="p">,</span> <span class="n">barItems</span><span class="p">:</span> <span class="p">[</span><span class="n">BarChartModel</span><span class="p">]</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
    <span class="n">backgroundColor</span> <span class="p">=</span> <span class="p">.</span><span class="n">white</span>
    <span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>これに合わせて、<code>ViewController.swift</code>において、<code>createContentsView</code>関数内の<code>GraphView</code>のインスタンス化部分を以下のように修正する。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">datum</span><span class="p">)</span> <span class="k">in</span> <span class="n">data</span><span class="p">.</span><span class="n">enumerated</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nv">pageView</span> <span class="p">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">barChartConf</span><span class="p">:</span> <span class="n">barChartConf</span><span class="p">,</span> <span class="n">barItems</span><span class="p">:</span> <span class="n">datum</span><span class="p">)</span>
      <span class="n">contentsView</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">pageView</span><span class="p">)</span>
  <span class="p">}</span></code></pre></div>
<p>これでエラーは出なくなるが、まだ何も描いてない。</p>
<h2 id="グラフ描画">グラフ描画</h2>
<p>ここまでくるとあとは前回と同じなので、さっと書く。<code>GraphView.swift</code>に以下の記述を追加する。前回とは違って、いくつかの処理をメソッドに分離している。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift">   <span class="kr">override</span> <span class="kd">func</span> <span class="nf">draw</span><span class="p">(</span><span class="kc">_</span> <span class="n">rect</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">context</span> <span class="p">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">(</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="s">Failed to get context.</span><span class="s">&#34;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">in</span> <span class="n">barItems</span><span class="p">.</span><span class="n">enumerated</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">drawBar</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">drawValue</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">drawName</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">drawAxis</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">drawBar</span><span class="p">(</span><span class="n">with</span> <span class="n">context</span><span class="p">:</span> <span class="n">CGContext</span><span class="p">,</span> <span class="n">of</span> <span class="n">item</span><span class="p">:</span> <span class="n">BarChartModel</span><span class="p">,</span> <span class="n">index</span> <span class="n">i</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">bcc</span> <span class="p">=</span> <span class="n">barChartConf</span>
        <span class="n">context</span><span class="p">.</span><span class="n">setFillColor</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">drawRect</span> <span class="p">=</span> <span class="n">UIBezierPath</span><span class="p">(</span><span class="n">rect</span><span class="p">:</span> <span class="n">CGRect</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="p">)</span> <span class="o">-</span> <span class="n">bcc</span><span class="p">.</span><span class="n">barWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">y</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">barWidth</span><span class="p">,</span>
            <span class="n">height</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">h</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="p">)</span>
        <span class="p">)</span><span class="p">)</span>
        <span class="n">drawRect</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawValue</span><span class="p">(</span><span class="n">with</span> <span class="n">context</span><span class="p">:</span> <span class="n">CGContext</span><span class="p">,</span> <span class="n">of</span> <span class="n">item</span><span class="p">:</span> <span class="n">BarChartModel</span><span class="p">,</span> <span class="n">index</span> <span class="n">i</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">bcc</span> <span class="p">=</span> <span class="n">barChartConf</span>
        <span class="kd">let</span> <span class="nv">to</span> <span class="p">=</span> <span class="n">bcc</span><span class="p">.</span><span class="n">textOption</span>
        <span class="kd">let</span> <span class="nv">value</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">valueTextRect</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="p">)</span> <span class="o">-</span> <span class="n">to</span><span class="p">.</span><span class="n">textWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">y</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">to</span><span class="p">.</span><span class="n">textHeight</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textWidth</span><span class="p">,</span>
            <span class="n">height</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textHeight</span>
        <span class="p">)</span>
        <span class="kd">let</span> <span class="nv">titleText</span> <span class="p">=</span> <span class="s">&#34;</span><span class="si">\(</span><span class="n">value</span><span class="si">)</span><span class="s">&#34;</span>
        <span class="n">titleText</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">valueTextRect</span><span class="p">,</span> <span class="n">withAttributes</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textFontAttributes</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawName</span><span class="p">(</span><span class="n">with</span> <span class="n">context</span><span class="p">:</span> <span class="n">CGContext</span><span class="p">,</span> <span class="n">of</span> <span class="n">item</span><span class="p">:</span> <span class="n">BarChartModel</span><span class="p">,</span> <span class="n">index</span> <span class="n">i</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">bcc</span> <span class="p">=</span> <span class="n">barChartConf</span>
        <span class="kd">let</span> <span class="nv">to</span> <span class="p">=</span> <span class="n">bcc</span><span class="p">.</span><span class="n">textOption</span>
        <span class="kd">let</span> <span class="nv">nameRect</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="p">)</span> <span class="o">-</span> <span class="n">to</span><span class="p">.</span><span class="n">textWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">y</span><span class="p">:</span> <span class="n">bcc</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">to</span><span class="p">.</span><span class="n">textHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textWidth</span><span class="p">,</span>
            <span class="n">height</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textHeight</span>
        <span class="p">)</span>
        <span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">nameRect</span><span class="p">,</span> <span class="n">withAttributes</span><span class="p">:</span> <span class="n">to</span><span class="p">.</span><span class="n">textFontAttributes</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawAxis</span><span class="p">(</span><span class="n">with</span> <span class="n">context</span><span class="p">:</span> <span class="n">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">setStrokeColor</span><span class="p">(</span><span class="n">UIColor</span><span class="p">.</span><span class="n">black</span><span class="p">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">scale</span> <span class="p">=</span> <span class="n">barChartConf</span><span class="p">.</span><span class="n">scale</span>
        <span class="kd">let</span> <span class="nv">path</span> <span class="p">=</span> <span class="n">UIBezierPath</span><span class="p">(</span><span class="p">)</span>
        <span class="n">path</span><span class="p">.</span><span class="n">move</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">CGPoint</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
        <span class="n">path</span><span class="p">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">CGPoint</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
        <span class="n">path</span><span class="p">.</span><span class="n">stroke</span><span class="p">(</span><span class="p">)</span>
    <span class="p">}</span></code></pre></div>
<figure>
    <img src="./mov02.gif" width="30%"/> 
</figure>

<p>大変だったがなんとか完成。</p>
<h2 id="追記-scrollviewのレイアウト修正">追記: ScrollViewのレイアウト修正</h2>
<p>実はいまのままだと、例えばtoolbarが出たときにレイアウトが崩れる。これを解決するために、ScrollViewを別のViewで包み、それにConstraintを設定する。</p>
<h3 id="mainstoryboard">Main.storyboard</h3>
<p>次のようにする。Viewを新しく作り、その中にScrollViewを配置する。</p>
<figure>
    <img src="./storyboard_main02.png" width="30%"/> 
</figure>

<h3 id="margin変数の削除">margin変数の削除</h3>
<p><code>ViewController</code>において、<code>marginX</code>と<code>marginY</code>の宣言を削除する。</p>
<h3 id="scrollviewのframe設定">scrollViewのframe設定</h3>
<p><code>viewDidLoad</code>において、<code>scrollView.frame</code>の代入文を以下のように修正する。</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">scrollView</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="n">CGRect</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">superview</span><span class="p">!</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">superview</span><span class="p">!</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">height</span>
<span class="p">)</span></code></pre></div>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://www.hackingwithswift.com/example-code/language/how-to-split-an-array-into-chunks">How to split an array into chunks - Hacking With Swift</a></li>
<li><a href="https://qiita.com/ynakaDream/items/960899183c38949c2ab0">【徹底解説】UIScrollViewクラス　その1</a></li>
</ul>

</article>



</html>
