<!DOCTYPE html>
<html lang="ja-jp">
<title>Elmメモ ドラッグ移動の実現(1) | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.77.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>



<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/elm-drag01/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/theme.css">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/classes.css">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/syntax.css">


<header class="dark">
  <h2><a href="https://bombrary.github.io/blog/">Chanomic Blog</a></h2>
  <nav>
    
  </nav>
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/elm-drag01/">Elmメモ ドラッグ移動の実現(1)</a></h1>
    <p class="meta"><time datetime="2020-02-25T19:15:00&#43;09:00">February 25, 2020</time></p>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/elm/">Elm</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/elm-svg/">elm-svg</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="tags_item"><a href="https://bombrary.github.io/blog//categories/elm/">Elm</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  
  <p>ElmでSVGの要素をドラッグ移動したいと思った。ドラッグ操作を実現するパッケージに<a href="https://package.elm-lang.org/packages/zaboco/elm-draggable/latest/">elm-draggable</a>がある。今回は勉強として、それに頼らず実装することを試みる。elm-draggableを用いた方法については次回やる。</p>
<h2 id="初期状態">初期状態</h2>
<p>詳細は省略するが、Elmプロジェクトを作成して<code>elm/svg</code>と<code>elm/json</code>をインストールしておく。</p>
<p><code>src/Main.elm</code>は以下のようにしておく。<code>elm reactor</code>で動くことを確認する。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kn">module </span><span class="nc">Main</span> <span class="nv">exposing</span> <span class="nf">(..)</span>

<span class="kn">import </span><span class="nc">Browser</span>
<span class="kn">import </span><span class="nc">Browser.Events</span> <span class="kr">as</span> <span class="kt">BE</span>
<span class="kn">import </span><span class="nc">Html</span> <span class="nv">exposing</span> <span class="nf">(..)</span>
<span class="kn">import </span><span class="nc">Html.Attributes</span> <span class="nv">exposing</span> <span class="nf">(..)</span>
<span class="kn">import </span><span class="nc">Json.Decode</span> <span class="kr">as</span> <span class="kt">JD</span>
<span class="kn">import </span><span class="nc">Svg</span> <span class="kr">as</span> <span class="kt">S</span> <span class="nv">exposing</span> <span class="p">(</span><span class="kt">Svg</span><span class="p">)</span>
<span class="kn">import </span><span class="nc">Svg.Attributes</span> <span class="kr">as</span> <span class="kt">SA</span>
<span class="kn">import </span><span class="nc">Svg.Events</span> <span class="kr">as</span> <span class="kt">SE</span>


<span class="kr">main </span><span class="nf">=</span>
    <span class="kt">Browser</span><span class="nf">.</span><span class="nv">element</span>
        <span class="p">{</span> <span class="nv">init</span> <span class="nf">=</span> <span class="nv">init</span>
        <span class="p">,</span> <span class="nv">update</span> <span class="nf">=</span> <span class="nv">update</span>
        <span class="p">,</span> <span class="nv">view</span> <span class="nf">=</span> <span class="nv">view</span>
        <span class="p">,</span> <span class="nv">subscriptions</span> <span class="nf">=</span> <span class="nv">subscriptions</span>
        <span class="p">}</span>


<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Model</span> <span class="nf">=</span>
    <span class="p">{}</span>


<span class="kr">type</span> <span class="kt">Msg</span>
    <span class="nf">=</span> <span class="kt">Dummy</span>


<span class="nv">init</span> <span class="nf">:</span> <span class="p">()</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">init</span> <span class="nv">_</span> <span class="nf">=</span>
    <span class="p">(</span> <span class="p">{},</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span> <span class="p">)</span>


<span class="nv">update</span> <span class="nf">:</span> <span class="kt">Msg</span> <span class="nf">-&gt;</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">update</span> <span class="nv">msg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="p">(</span> <span class="nv">model</span><span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span> <span class="p">)</span>


<span class="nv">view</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="nv">view</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="nv">div</span> <span class="p">[]</span> <span class="p">[]</span>


<span class="nv">subscriptions</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Sub</span> <span class="kt">Msg</span>
<span class="nv">subscriptions</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kt">Sub</span><span class="nf">.</span><span class="nv">none</span></code></pre></div>
<h2 id="目標">目標</h2>
<ul>
<li>SVGの領域に円が複数存在する</li>
<li>円をドラッグ移動できるようにしたい。</li>
<li>円のドラッグ中はその色を橙色にし、それ以外のときは白にする</li>
</ul>
<h2 id="方針">方針</h2>
<p>ドラッグ処理については次の処理で実現することになる。</p>
<ul>
<li>ドラッグ開始は<code>Svg.Events.onMouseDown</code>を<code>ciecle</code>要素に付ける</li>
<li>ドラッグ中は<code>Svg.Events.onMouseMove</code>を<code>svg</code>要素に付ける</li>
<li>ドラッグ終了は<code>Browser.Events.onMouseUp</code>を<code>subscription</code>で登録する</li>
</ul>
<p>いくつかの方針が考えられ、かつ慎重に考えなければならないことは、次の3点。</p>
<ul>
<li>円をどんな形で扱うか:  特に、色の情報を円に持たせるか否か</li>
<li>円の集合をどんな形で扱うか:  円が<code>Circle</code>だとして、<code>List Circle</code>にするか、<code>Set Circle</code>にするか。もしくは何か<code>Id</code>を持たせて、<code>Dict Id Circle</code>にするか、など</li>
<li>ドラッグ中の円をどんな形で扱うか:  <code>Model</code>にドラッグ中の<code>Circle</code>を直接持たせるか、それとも<code>Circle</code>の<code>Id</code>を持たせるか、など。</li>
</ul>
<h3 id="今回の方針">今回の方針</h3>
<p>結局何がベストなのかはよく分からないのだが、とりあえず今回は次のようにやってみる。</p>
<ul>
<li>円は ( id, x座標, y座標, 半径 ) の情報を持つ。idは<code>Int</code>として扱う。</li>
<li>円の集合は<code>List Circle</code>として持つ。また、円の<code>id</code>は一意であって欲しいので、「次付与する<code>id</code>」も情報として持たせることにする。これをまとめて<code>Circles</code>と呼ぶことにする。</li>
<li>ドラッグされている状態の<code>Circle</code>をの<code>id</code>を<code>Model</code>内に持たせる。具体的には、<code>hold : Maybe Id</code>としてレコードに持たせる。</li>
</ul>
<h3 id="3点目についての補足">3点目についての補足</h3>
<p><code>Model</code>に<code>Circle</code>を直接持たせる場合、ドラッグ中の<code>Circle</code>と<code>Circles</code>に含まれている<code>Circle</code>とのデータの同期を取る必要がある。同期を取るのは面倒なので、次のようにやる方が良い。</p>
<ul>
<li>ドラッグ中の<code>Circle</code>と他の<code>Circle</code>を別々に管理する</li>
<li>ドラッグ開始時、<code>Circles</code>からドラッグ中の<code>Circle</code>を一旦削除して、ドラッグ終了後に再び戻す。</li>
<li>描画するときは、ドラッグ中の<code>Circle</code>と他の<code>Circle</code>を統合する</li>
</ul>
<p>個人的にはこの処理を書くのが少し面倒に感じたので、<code>Model</code>にはドラッグ中の<code>Circle</code>の<code>Id</code>だけ持たせておいて、それを使って<code>Circles</code>内の<code>Circle</code>を操作する方針を選んだ。</p>
<p>ただし、<code>Circle</code>を持たせることが活きてくる状況として、「ドラッグ中に何か特別な情報を<code>Circle</code>に持たせる場合」が考えられる。例えば、ドラッグ中の円に対して、「ドラッグ開始時の座標が何だったか」「他の円との距離」を持たせる場合が考えられる。このような場合は、ドラッグ中の円とドラッグしていない円とで分けてデータを管理したほうが良さそう。</p>
<p><strong>追記(2020/02/26):</strong>
<a href="https://github.com/zaboco/elm-draggable/blob/master/examples/MultipleTargetsExample.elm">elm-draggableのサンプルの1つ</a>に、上記と似た実装があった。ただし、ここではドラッグ中の要素<code>movingBox</code>を<code>Model</code>ではなく要素の集合<code>BoxGroup</code>内に持たせている。座標を更新したいときは<code>movingBox</code>を変更すればよいだけ。この方針も悪くない、と思った。</p>
<h2 id="circlecircles-の定義">Circle/Circles の定義</h2>
<p><code>src/Circle.elm</code>を作成し、そちらで<code>Circle</code>と<code>Circles</code>を定義する。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kn">module </span><span class="nc">Circle</span> <span class="nv">exposing</span> <span class="nf">(..)</span>

<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Id</span> <span class="nf">=</span> <span class="kt">Int</span>

<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Circle</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">id</span> <span class="nf">:</span> <span class="kt">Id</span>
    <span class="p">,</span> <span class="nv">x</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">y</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">r</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">}</span>


<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Circles</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">all</span> <span class="nf">:</span> <span class="kt">List</span> <span class="kt">Circle</span>
    <span class="p">,</span> <span class="nv">nextId</span> <span class="nf">:</span> <span class="kt">Id</span>
    <span class="p">}</span></code></pre></div>
<h3 id="ユーティリティ関数の定義">ユーティリティ関数の定義</h3>
<p><code>Circles</code>の内部表現を気にせずに扱えるように、いくつかのユーティリティ関数を定義しておく。<code>add</code>関数は円を追加したいときに呼び出す関数だが、今回は利用しない。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">empty</span> <span class="nf">:</span> <span class="kt">Circles</span>
<span class="nv">empty</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">all</span> <span class="nf">=</span> <span class="p">[]</span>
    <span class="p">,</span> <span class="nv">nextId</span> <span class="nf">=</span> <span class="mi">0</span>
    <span class="p">}</span>


<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">CircleNoId</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">x</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">y</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">r</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">}</span>


<span class="nv">fromList</span> <span class="nf">:</span> <span class="kt">List</span> <span class="kt">CircleNoId</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span>
<span class="nv">fromList</span> <span class="nv">list</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">all</span> <span class="nf">=</span> <span class="kt">List</span><span class="nf">.</span><span class="nv">indexedMap</span> <span class="p">(</span><span class="nf">\</span><span class="nv">i</span> <span class="nv">c</span> <span class="nf">-&gt;</span> <span class="p">{</span> <span class="nv">id</span> <span class="nf">=</span> <span class="nv">i</span><span class="p">,</span> <span class="nv">x</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">x</span><span class="p">,</span> <span class="nv">y</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">y</span><span class="p">,</span> <span class="nv">r</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">r</span> <span class="p">})</span> <span class="nv">list</span>
    <span class="p">,</span> <span class="nv">nextId</span> <span class="nf">=</span> <span class="kt">List</span><span class="nf">.</span><span class="nv">length</span> <span class="nv">list</span>
    <span class="p">}</span>


<span class="nv">toList</span> <span class="nf">:</span> <span class="kt">Circles</span> <span class="nf">-&gt;</span> <span class="kt">List</span> <span class="kt">Circle</span>
<span class="nv">toList</span> <span class="nv">circles</span> <span class="nf">=</span>
    <span class="nv">circles</span><span class="nf">.</span><span class="nv">all</span>

<span class="nv">add</span> <span class="nf">:</span> <span class="kt">CircleNoId</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span>
<span class="nv">add</span> <span class="nv">c</span> <span class="nv">circles</span> <span class="nf">=</span>
    <span class="kr">let</span>
        <span class="nv">circle</span> <span class="nf">=</span>
            <span class="p">{</span> <span class="nv">id</span> <span class="nf">=</span> <span class="nv">circles</span><span class="nf">.</span><span class="nv">nextId</span>
            <span class="p">,</span> <span class="nv">x</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">x</span>
            <span class="p">,</span> <span class="nv">y</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">y</span>
            <span class="p">,</span> <span class="nv">r</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">r</span>
            <span class="p">}</span>
    <span class="kr">in</span>
    <span class="p">{</span> <span class="nv">circles</span>
        <span class="nf">|</span> <span class="nv">all</span> <span class="nf">=</span> <span class="nv">circle</span> <span class="nf">::</span> <span class="nv">circles</span><span class="nf">.</span><span class="nv">all</span>
        <span class="p">,</span> <span class="nv">nextId</span> <span class="nf">=</span> <span class="nv">circles</span><span class="nf">.</span><span class="nv">nextId</span> <span class="nf">+</span> <span class="mi">1</span>
    <span class="p">}</span>

<span class="nv">update</span> <span class="nf">:</span> <span class="kt">Id</span> <span class="nf">-&gt;</span> <span class="p">(</span><span class="kt">Circle</span> <span class="nf">-&gt;</span> <span class="kt">Circle</span><span class="p">)</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span>
<span class="nv">update</span> <span class="nv">id</span> <span class="nv">f</span> <span class="nv">circles</span> <span class="nf">=</span>
    <span class="kr">let</span>
        <span class="nv">new</span> <span class="nf">=</span>
            <span class="kt">List</span><span class="nf">.</span><span class="nv">foldr</span>
                <span class="p">(</span><span class="nf">\</span><span class="nv">c</span> <span class="nv">acc</span> <span class="nf">-&gt;</span>
                    <span class="kr">if</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">id</span> <span class="nf">==</span> <span class="nv">id</span> <span class="kr">then</span>
                        <span class="nv">f</span> <span class="nv">c</span> <span class="nf">::</span> <span class="nv">acc</span>

                    <span class="kr">else</span>
                        <span class="nv">c</span> <span class="nf">::</span> <span class="nv">acc</span>
                <span class="p">)</span>
                <span class="p">[]</span>
                <span class="nv">circles</span><span class="nf">.</span><span class="nv">all</span>
    <span class="kr">in</span>
    <span class="p">{</span> <span class="nv">circles</span> <span class="nf">|</span> <span class="nv">all</span> <span class="nf">=</span> <span class="nv">new</span> <span class="p">}</span></code></pre></div>
<h2 id="円の描画">円の描画</h2>
<p><code>src/Main.elm</code>に戻る。次の<code>import</code>文を追加。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kn">import </span><span class="nc">Circle</span> <span class="kr">as</span> <span class="kt">C</span> <span class="nv">exposing</span> <span class="p">(</span><span class="kt">Circle</span><span class="p">,</span> <span class="kt">CircleNoId</span><span class="p">,</span> <span class="kt">Circles</span><span class="p">,</span> <span class="kt">Id</span><span class="p">)</span></code></pre></div>
<h3 id="modelの変更">Modelの変更</h3>
<p><code>Model</code>に<code>Circles</code>を追加しておく。<code>circles</code>としていくつかの初期データを投入しておく。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Model</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">circles</span> <span class="nf">:</span> <span class="kt">Circles</span>
    <span class="p">}</span>

<span class="nf">...</span>

<span class="nv">init</span> <span class="nf">:</span> <span class="p">()</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">init</span> <span class="nv">_</span> <span class="nf">=</span>
    <span class="p">(</span> <span class="p">{</span> <span class="nv">circles</span> <span class="nf">=</span>
            <span class="kt">C</span><span class="nf">.</span><span class="nv">fromList</span>
                <span class="p">[</span> <span class="kt">CircleNoId</span> <span class="mi">10</span> <span class="mi">10</span> <span class="mi">10</span>
                <span class="p">,</span> <span class="kt">CircleNoId</span> <span class="mi">20</span> <span class="mi">100</span> <span class="mi">20</span>
                <span class="p">,</span> <span class="kt">CircleNoId</span> <span class="mi">250</span> <span class="mi">250</span> <span class="mi">30</span>
                <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
    <span class="p">)</span></code></pre></div>
<h3 id="viewの変更">Viewの変更</h3>
<p>SVG描画の処理は<code>viewSvg</code>に任せる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">view</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="nv">view</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="nv">div</span> <span class="p">[]</span>
        <span class="p">[</span> <span class="nv">viewSvg</span> <span class="nv">model</span>
        <span class="p">]</span>


<span class="nv">viewSvg</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewSvg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">svg</span>
        <span class="p">[</span> <span class="nv">style</span> <span class="s">&#34;border&#34;</span> <span class="s">&#34;1px solid #000&#34;</span>
        <span class="p">,</span> <span class="nv">style</span> <span class="s">&#34;width&#34;</span> <span class="s">&#34;500px&#34;</span>
        <span class="p">,</span> <span class="nv">style</span> <span class="s">&#34;height&#34;</span> <span class="s">&#34;500px&#34;</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="nv">viewCircles</span> <span class="nv">model</span>
        <span class="p">]</span></code></pre></div>
<p><code>Circle(s)</code>の描画を<code>viewCircle(s)</code>に任せる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">viewCircles</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewCircles</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">g</span> <span class="p">[]</span>
        <span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span> <span class="p">(</span><span class="nv">viewCircle</span> <span class="nv">model</span><span class="p">)</span> <span class="p">(</span><span class="kt">C</span><span class="nf">.</span><span class="nv">toList</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">circles</span><span class="p">))</span>


<span class="nv">viewCircle</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Circle</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewCircle</span> <span class="nv">model</span> <span class="nv">circle</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">g</span>
        <span class="p">[</span> <span class="kt">SA</span><span class="nf">.</span><span class="nv">transform</span> <span class="p">(</span><span class="nv">translate</span> <span class="nv">circle</span><span class="nf">.</span><span class="nv">x</span> <span class="nv">circle</span><span class="nf">.</span><span class="nv">y</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="kt">S</span><span class="nf">.</span><span class="nv">circle</span>
            <span class="p">[</span> <span class="kt">SA</span><span class="nf">.</span><span class="nv">r</span> <span class="p">(</span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">circle</span><span class="nf">.</span><span class="nv">r</span><span class="p">)</span>
            <span class="p">,</span> <span class="kt">SA</span><span class="nf">.</span><span class="nv">fill</span> <span class="s">&#34;#fff&#34;</span>
            <span class="p">,</span> <span class="kt">SA</span><span class="nf">.</span><span class="nv">stroke</span> <span class="s">&#34;#000&#34;</span>
            <span class="p">]</span>
            <span class="p">[]</span>
        <span class="p">]</span>


<span class="nv">translate</span> <span class="nf">:</span> <span class="kt">Float</span> <span class="nf">-&gt;</span> <span class="kt">Float</span> <span class="nf">-&gt;</span> <span class="kt">String</span>
<span class="nv">translate</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nf">=</span>
    <span class="s">&#34;translate(&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">x</span> <span class="nf">++</span> <span class="s">&#34;,&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">y</span> <span class="nf">++</span> <span class="s">&#34;)&#34;</span></code></pre></div>
<p>ここで、<code>viewCircle</code>、<code>viewCircles</code>は<code>Model</code>を引数にとるようにした。一般に、<code>view</code>と同じく要素の描画を担う関数に関しては、<code>Model</code>を引数にとった方が、後々の修正や変更が楽になると思われる。なぜなら、<code>Model</code>こそが要素描画のための全ての情報を持っているからである。「今はCircleの情報をもとに描画してたけど、それだけじゃなくてXXの情報も必要になった」などの変更に、比較的簡単に対応できる。</p>
<p><strong>追記(2020/03/04):</strong> ただし、<code>Model</code>を引数にとる、という情報だけでは「この関数の機能を実現するためにはどんな値が必要なのか」が分からないため、ソースコードから関数の機能を予想するのが難しくなるかもしれない。なので一概に良いとは言い切れない。</p>
<p>ここまで実装すると、実行結果は以下のようになる。</p>
<figure>
    <img src="./sc01.png" width="50%"/> 
</figure>

<h2 id="円をクリック中の色変化">円をクリック中の色変化</h2>
<h3 id="holdの定義">holdの定義</h3>
<p>ドラッグ状態にある円を<code>hold</code>として<code>Model</code>に持たせる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Model</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">circles</span> <span class="nf">:</span> <span class="kt">Circles</span>
    <span class="p">,</span> <span class="nv">hold</span> <span class="nf">:</span> <span class="kt">Maybe</span> <span class="kt">Id</span>
    <span class="p">}</span>

<span class="nf">...</span>

<span class="nv">init</span> <span class="nf">:</span> <span class="p">()</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">init</span> <span class="nv">_</span> <span class="nf">=</span>
    <span class="p">(</span> <span class="p">{</span> <span class="nv">circles</span> <span class="nf">=</span> <span class="nf">...</span>
      <span class="p">,</span> <span class="nv">hold</span> <span class="nf">=</span> <span class="kt">Nothing</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
    <span class="p">)</span></code></pre></div>
<h3 id="ドラッグ開始イベントの定義">ドラッグ開始イベントの定義</h3>
<p>circle要素に対してマウスが押下されたときに、<code>CircleHeld id</code>という<code>Msg</code>を送る。<code>CircleHeld</code>を受け取ったとき、<code>hold</code>に円のデータを入れる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kt">Msg</span>
    <span class="nf">=</span> <span class="kt">CircleHeld</span> <span class="kt">Id</span>

<span class="nf">...</span>

<span class="nv">update</span> <span class="nf">:</span> <span class="kt">Msg</span> <span class="nf">-&gt;</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">update</span> <span class="nv">msg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">msg</span> <span class="kr">of</span>
        <span class="kt">CircleHeld</span> <span class="nv">id</span> <span class="nf">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="nv">model</span> <span class="nf">|</span> <span class="nv">hold</span> <span class="nf">=</span> <span class="kt">Just</span> <span class="nv">id</span> <span class="p">}</span>
            <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
            <span class="p">)</span>

<span class="nf">...</span>

<span class="nv">viewCircle</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Circle</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewCircle</span> <span class="nv">model</span> <span class="nv">circle</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">g</span>
        <span class="p">[</span> <span class="nf">...</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="kt">S</span><span class="nf">.</span><span class="nv">circle</span>
            <span class="p">[</span> <span class="nf">...</span>
            <span class="p">,</span> <span class="kt">SE</span><span class="nf">.</span><span class="nv">onMouseDown</span> <span class="p">(</span><span class="kt">CircleHeld</span> <span class="nv">circle</span><span class="nf">.</span><span class="nv">id</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="p">[]</span>
        <span class="p">]</span></code></pre></div>
<h3 id="ドラッグ中の色の変更">ドラッグ中の色の変更</h3>
<p><code>fillCircle</code>関数が担う。これは、ドラッグ中の円のときだけ橙色のカラーコードを返す。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">viewCircle</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Circle</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewCircle</span> <span class="nv">model</span> <span class="nv">circle</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">g</span>
        <span class="p">[</span> <span class="nf">...</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="kt">S</span><span class="nf">.</span><span class="nv">circle</span>
            <span class="p">[</span> <span class="nf">...</span>
            <span class="p">,</span> <span class="kt">SA</span><span class="nf">.</span><span class="nv">fill</span> <span class="p">(</span><span class="nv">fillCircle</span> <span class="nv">model</span> <span class="nv">circle</span><span class="p">)</span>
            <span class="nf">...</span>
            <span class="p">]</span>
            <span class="p">[]</span>
        <span class="p">]</span>


<span class="nv">fillCircle</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Circle</span> <span class="nf">-&gt;</span> <span class="kt">String</span>
<span class="nv">fillCircle</span> <span class="nv">model</span> <span class="nv">circle</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">hold</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="nf">-&gt;</span>
            <span class="s">&#34;#fff&#34;</span>

        <span class="kt">Just</span> <span class="nv">id</span> <span class="nf">-&gt;</span>
            <span class="kr">if</span> <span class="nv">circle</span><span class="nf">.</span><span class="nv">id</span> <span class="nf">==</span> <span class="nv">id</span> <span class="kr">then</span>
                <span class="s">&#34;#f80&#34;</span>

            <span class="kr">else</span>
                <span class="s">&#34;#fff&#34;</span></code></pre></div>
<h3 id="ドラッグ終了イベントの定義">ドラッグ終了イベントの定義</h3>
<p>マウスが離されたときに、<code>CircleReleased</code>というメッセージを送る。特定のDOM要素に依存しないイベントを監視する場合は、<code>subscription</code>を用いる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kt">Msg</span>
    <span class="nf">=</span> <span class="kt">CircleHeld</span> <span class="kt">Id</span>
    <span class="nf">|</span> <span class="kt">CircleReleased</span>

<span class="nf">...</span>


<span class="nv">update</span> <span class="nf">:</span> <span class="kt">Msg</span> <span class="nf">-&gt;</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">update</span> <span class="nv">msg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">msg</span> <span class="kr">of</span>
        <span class="nf">...</span>

        <span class="kt">CircleReleased</span> <span class="nf">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="nv">model</span> <span class="nf">|</span> <span class="nv">hold</span> <span class="nf">=</span> <span class="kt">Nothing</span> <span class="p">}</span>
            <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
            <span class="p">)</span>

<span class="nf">...</span>

<span class="nv">subscriptions</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Sub</span> <span class="kt">Msg</span>
<span class="nv">subscriptions</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="nv">subHold</span> <span class="nv">model</span>


<span class="nv">subHold</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Sub</span> <span class="kt">Msg</span>
<span class="nv">subHold</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">hold</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="nf">-&gt;</span>
            <span class="kt">Sub</span><span class="nf">.</span><span class="nv">none</span>

        <span class="kt">Just</span> <span class="nv">_</span> <span class="nf">-&gt;</span>
            <span class="kt">BE</span><span class="nf">.</span><span class="nv">onMouseUp</span> <span class="p">(</span><span class="kt">JD</span><span class="nf">.</span><span class="nv">succeed</span> <span class="kt">CircleReleased</span><span class="p">)</span></code></pre></div>
<p><code>Browser.Event.onMouseUp</code>を用いた。<code>Browser.Event</code>で提供される関数の多くは、引数に<code>Json.Decode.Decoder msg</code>をとる。これは何をDecodeするのかというと、JSのEventオブジェクトをDecodeする。今回はEventから何も取得する必要はないので、<code>Json.Decode.succeed</code>を用いる。</p>
<p>実行結果は以下のようになる。</p>
<figure>
    <img src="./sc02.gif"/> 
</figure>

<h2 id="マウス位置の取得">マウス位置の取得</h2>
<p>さて円のドラッグ移動とは、より詳しくいうと「円をクリックしている間にマウスを移動すると、円がそれに追従する」機能だ。これを実現するためには、マウスの位置ではなく「マウスがどれだけ動いたか」という情報も欲しい。マウスの位置は(Mouse)Eventオブジェクトの<code>offsetX</code>と<code>offsetY</code>で取得できる。マウスの移動量は、1つ前に発火したイベントの<code>x</code> <code>y</code>の位置の差分として計算する。</p>
<p>補足。マウスの移動量については<code>movementX</code>と<code>movementY</code>が使えそうかなと思ったが、ドラッグ位置がずれた。<a href="https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/movementX">movementXの説明</a>的にはずれなさそうなのだが。よくわからない。</p>
<h3 id="modelの定義">Modelの定義</h3>
<p><code>mouse : MousePosition</code>を定義する。「マウスがどれだけ動いたか」の情報は<code>dx: Float</code>と<code>dy: Float</code>で持たせる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kr">alias</span> <span class="kt">Model</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">circles</span> <span class="nf">:</span> <span class="kt">Circles</span>
    <span class="p">,</span> <span class="nv">hold</span> <span class="nf">:</span> <span class="kt">Maybe</span> <span class="kt">Circle</span>
    <span class="p">,</span> <span class="nv">mouse</span> <span class="nf">:</span> <span class="kt">MousePosition</span>
    <span class="p">}</span>


<span class="kr">type</span> <span class="kr">alias</span> <span class="kt">MousePosition</span> <span class="nf">=</span>
    <span class="p">{</span> <span class="nv">x</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">y</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">dx</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">,</span> <span class="nv">dy</span> <span class="nf">:</span> <span class="kt">Float</span>
    <span class="p">}</span>

<span class="nf">...</span>

<span class="nv">init</span> <span class="nf">:</span> <span class="p">()</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">init</span> <span class="nv">_</span> <span class="nf">=</span>
    <span class="p">(</span> <span class="p">{</span> <span class="nf">...</span>
      <span class="p">,</span> <span class="nv">mouse</span> <span class="nf">=</span> <span class="kt">MousePosition</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
    <span class="p">)</span></code></pre></div>
<h3 id="マウス移動のイベント">マウス移動のイベント</h3>
<p>SVG領域内の左上を原点として座標を取得したいので、SVGに対して<code>mousemove</code>イベントを登録したい。しかし<code>Svg.Event.onMouseMove</code>みたいな関数は用意されていないので、自作する。<code>Svg.Event.on</code>関数を使う。これも<code>Browser.Event.onMouseUp</code>のときと同様引数に<code>Json.Decode.Decoder msg</code>をとり、JSのEventをDecodeする。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="kr">type</span> <span class="kt">Msg</span>
    <span class="nf">=</span> <span class="nf">...</span>
    <span class="nf">|</span> <span class="kt">MouseMoved</span> <span class="kt">Float</span> <span class="kt">Float</span>

<span class="nf">...</span>

<span class="nv">update</span> <span class="nf">:</span> <span class="kt">Msg</span> <span class="nf">-&gt;</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">update</span> <span class="nv">msg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">msg</span> <span class="kr">of</span>
        <span class="nf">...</span>

        <span class="kt">MouseMoved</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nf">-&gt;</span>
            <span class="kr">let</span>
                <span class="nv">newMouse</span> <span class="nf">=</span>
                    <span class="p">{</span> <span class="nv">x</span> <span class="nf">=</span> <span class="nv">x</span>
                    <span class="p">,</span> <span class="nv">y</span> <span class="nf">=</span> <span class="nv">y</span>
                    <span class="p">,</span> <span class="nv">dx</span> <span class="nf">=</span> <span class="nv">x</span> <span class="nf">-</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">mouse</span><span class="nf">.</span><span class="nv">x</span>
                    <span class="p">,</span> <span class="nv">dy</span> <span class="nf">=</span> <span class="nv">y</span> <span class="nf">-</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">mouse</span><span class="nf">.</span><span class="nv">y</span>
                    <span class="p">}</span>
            <span class="kr">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="nv">model</span>
                <span class="nf">|</span> <span class="nv">mouse</span> <span class="nf">=</span> <span class="nv">newMouse</span>
              <span class="p">}</span>
            <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
            <span class="p">)</span>

<span class="nf">...</span>

<span class="nv">viewSvg</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Svg</span> <span class="kt">Msg</span>
<span class="nv">viewSvg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kt">S</span><span class="nf">.</span><span class="nv">svg</span>
        <span class="p">[</span><span class="nf">...</span>
        <span class="p">,</span> <span class="nv">onMouseMove</span> <span class="kt">MouseMoved</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="nf">...</span>
        <span class="p">]</span>


<span class="nv">onMouseMove</span> <span class="nf">:</span> <span class="p">(</span><span class="kt">Float</span> <span class="nf">-&gt;</span> <span class="kt">Float</span> <span class="nf">-&gt;</span> <span class="nv">msg</span><span class="p">)</span> <span class="nf">-&gt;</span> <span class="kt">S</span><span class="nf">.</span><span class="kt">Attribute</span> <span class="nv">msg</span>
<span class="nv">onMouseMove</span> <span class="nv">msg</span> <span class="nf">=</span>
    <span class="kt">SE</span><span class="nf">.</span><span class="nv">on</span> <span class="s">&#34;mousemove&#34;</span>
        <span class="p">(</span><span class="kt">JD</span><span class="nf">.</span><span class="nv">map</span><span class="mi">2</span> <span class="nv">msg</span>
            <span class="p">(</span><span class="kt">JD</span><span class="nf">.</span><span class="nv">field</span> <span class="s">&#34;offsetX&#34;</span> <span class="kt">JD</span><span class="nf">.</span><span class="nv">float</span><span class="p">)</span>
            <span class="p">(</span><span class="kt">JD</span><span class="nf">.</span><span class="nv">field</span> <span class="s">&#34;offsetY&#34;</span> <span class="kt">JD</span><span class="nf">.</span><span class="nv">float</span><span class="p">)</span>
        <span class="p">)</span></code></pre></div>
<p>試しにマウス座標を出力してみる。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">view</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="nv">view</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="nv">div</span> <span class="p">[]</span>
        <span class="p">[</span> <span class="nf">...</span>
        <span class="p">,</span> <span class="nv">viewMousePosition</span> <span class="nv">model</span>
        <span class="p">]</span>


<span class="nv">viewMousePosition</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="nv">viewMousePosition</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="nv">div</span> <span class="p">[]</span>
        <span class="p">[</span> <span class="nv">p</span> <span class="p">[]</span>
            <span class="p">[</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">textMousePosition</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">mouse</span><span class="p">)</span> <span class="p">]</span>
        <span class="p">,</span> <span class="nv">p</span> <span class="p">[]</span>
            <span class="p">[</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">textMouseMovement</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">mouse</span><span class="p">)</span> <span class="p">]</span>
        <span class="p">]</span>


<span class="nv">textMousePosition</span> <span class="nf">:</span> <span class="kt">MousePosition</span> <span class="nf">-&gt;</span> <span class="kt">String</span>
<span class="nv">textMousePosition</span> <span class="nv">mouse</span> <span class="nf">=</span>
    <span class="s">&#34;(&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">x</span> <span class="nf">++</span> <span class="s">&#34;,&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">y</span> <span class="nf">++</span> <span class="s">&#34;)&#34;</span>


<span class="nv">textMouseMovement</span> <span class="nf">:</span> <span class="kt">MousePosition</span> <span class="nf">-&gt;</span> <span class="kt">String</span>
<span class="nv">textMouseMovement</span> <span class="nv">mouse</span> <span class="nf">=</span>
    <span class="s">&#34;(&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">dx</span> <span class="nf">++</span> <span class="s">&#34;,&#34;</span> <span class="nf">++</span> <span class="kt">String</span><span class="nf">.</span><span class="nv">fromFloat</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">dy</span> <span class="nf">++</span> <span class="s">&#34;)&#34;</span></code></pre></div>
<p>試しにマウスを動かしてみると、下にその座標と移動量が表示される。</p>
<figure>
    <img src="./sc03.png" width="50%"/> 
</figure>

<h2 id="円を動かす">円を動かす</h2>
<p><code>MouseMoved</code>を受け取ったときに、<code>Circle</code>の座標を更新すればよい。</p>
<div class="highlight"><pre class="chroma"><code class="language-elm" data-lang="elm"><span class="nv">update</span> <span class="nf">:</span> <span class="kt">Msg</span> <span class="nf">-&gt;</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="p">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="nv">update</span> <span class="nv">msg</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">msg</span> <span class="kr">of</span>
        <span class="nf">...</span>
        <span class="kt">MouseMoved</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nf">-&gt;</span>
            <span class="kr">let</span>
              <span class="nf">...</span>
            <span class="kr">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="nv">model</span>
                <span class="nf">|</span> <span class="nv">mouse</span> <span class="nf">=</span> <span class="nv">newMouse</span>
                <span class="p">,</span> <span class="nv">circles</span> <span class="nf">=</span> <span class="nv">updateCircles</span> <span class="nv">model</span> <span class="nv">newMouse</span>
              <span class="p">}</span>
            <span class="p">,</span> <span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
            <span class="p">)</span>


<span class="nv">updateCircles</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">MousePosition</span> <span class="nf">-&gt;</span> <span class="kt">Circles</span>
<span class="nv">updateCircles</span> <span class="nv">model</span> <span class="nv">mouse</span> <span class="nf">=</span>
    <span class="kr">case</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">hold</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="nf">-&gt;</span>
            <span class="nv">model</span><span class="nf">.</span><span class="nv">circles</span>

        <span class="kt">Just</span> <span class="nv">id</span> <span class="nf">-&gt;</span>
            <span class="kt">C</span><span class="nf">.</span><span class="nv">update</span> <span class="nv">id</span>
                <span class="p">(</span><span class="nf">\</span><span class="nv">c</span> <span class="nf">-&gt;</span>
                    <span class="p">{</span> <span class="nv">c</span>
                        <span class="nf">|</span> <span class="nv">x</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">x</span> <span class="nf">+</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">dx</span>
                        <span class="p">,</span> <span class="nv">y</span> <span class="nf">=</span> <span class="nv">c</span><span class="nf">.</span><span class="nv">y</span> <span class="nf">+</span> <span class="nv">mouse</span><span class="nf">.</span><span class="nv">dy</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="nv">model</span><span class="nf">.</span><span class="nv">circles</span></code></pre></div>
<p>良い感じで動いている。</p>
<figure>
    <img src="./sc04.gif" width="40%"/> 
</figure>


</article>



</html>
