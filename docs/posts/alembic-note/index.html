<!DOCTYPE html>
<html lang="ja-jp">
<title>Alembicを使ったDBマイグレーション（備忘録） | Chanomic Blog</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.121.1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://bombrary.github.io/blog/css/index.css">
<link rel="canonical" href="https://bombrary.github.io/blog/posts/alembic-note/">
<link rel="alternate" type="application/rss+xml" href="" title="Chanomic Blog">
  <link rel="stylesheet" href="/blog/css/custom.css">

  <link rel="stylesheet" href="/blog/css/syntax.css">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152083322-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152083322-1');
</script>



<meta property="og:title" content="Alembicを使ったDBマイグレーション（備忘録）" />
<meta property="og:description" content="経緯 Alembicというライブラリを知ったので、試しに触ってみたメモ。
そもそもAlembicとは Alembicとは、DBマイグレーションライブラリの1つ。SQLAlchemyと一緒に用いる。
今回やってみること 今回行うマイグレーションは、以下の3つ。
空 User(email, password)を作成 User(email, password, name)に変更 使い方 Alembicの初期化 使うDBとの紐づけ エンティティ作成 マイグレーションファイルを作成 マイグレーション 想定する状況と準備 FastAPI上でWeb APIを提供し、その中でDBを操作することを想定する。ただし、メインテーマがマイグレーションのため、この記事でFastAPIの話は一切出ない。プロジェクト作成について、詳しくはFastAPI入門を参照するとよい。この記事では、ディレクトリ構成を大きく参考にしている。 パッケージ管理にはpoetryを使う。 DBにはMySQLを使う。 マイグレーションは同期処理で行うため、入れるのはPyMySQLだけでよい。しかしFastAPIでDBを処理するときに非同期での操作を行うことを見越し、aiomysqlを入れる。この時点でPyMySQLも入る。
poetry add sqlalchemy alembic aiomysql alembicの初期化 次のコマンドを実行する。
poetry run alembic init alembic プロジェクト配下にalembic/というディレクトリが生成される。
使うDBとの紐づけ alembic.iniを編集する。sqlalchemy.urlの記述を見つけたら以下のようにする。
sqlalchemy.url = mysql&#43;pymysql://&lt;url&gt;/&lt;name&gt;?charset=utf8 &lt;url&gt;と&lt;name&gt;にはそれぞれ、mysqlのサーバーのURLとそのDBの名前を指定する。例えばmysqlがdbというDocker Composeのサービスとして稼働しており、3306ポートで受け付けており、そのDBの名前がappdbだった場合、次のようになる。
sqlalchemy.url = mysql&#43;pymysql://root@db:3306/appdb?charset=utf8 api/db.pyにDBエンティティのベースを作っておく。
from sqlalchemy.ext.declarative import declarative_base Base = declarative_base() alembic/env.pyのtarget_metadataを以下のようにする。
from api.db import Base target_metadata = Base.metadata 空のマイグレーション まだエンティティを作成していない状態でマイグレーションを行ってみる。
マイグレーション用のファイル作成 以下でマイグレーション用のファイルを作成する
poetry run alembic revision --autogenerate -m &#34;empty revision&#34; alembic/versionsにマイグレーション用のファイルが生成されている。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bombrary.github.io/blog/posts/alembic-note/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T18:38:00+09:00" />
<meta property="article:modified_time" content="2023-06-25T15:09:12+09:00" />


<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Alembicを使ったDBマイグレーション（備忘録）"/>
<meta name="twitter:description" content="経緯 Alembicというライブラリを知ったので、試しに触ってみたメモ。
そもそもAlembicとは Alembicとは、DBマイグレーションライブラリの1つ。SQLAlchemyと一緒に用いる。
今回やってみること 今回行うマイグレーションは、以下の3つ。
空 User(email, password)を作成 User(email, password, name)に変更 使い方 Alembicの初期化 使うDBとの紐づけ エンティティ作成 マイグレーションファイルを作成 マイグレーション 想定する状況と準備 FastAPI上でWeb APIを提供し、その中でDBを操作することを想定する。ただし、メインテーマがマイグレーションのため、この記事でFastAPIの話は一切出ない。プロジェクト作成について、詳しくはFastAPI入門を参照するとよい。この記事では、ディレクトリ構成を大きく参考にしている。 パッケージ管理にはpoetryを使う。 DBにはMySQLを使う。 マイグレーションは同期処理で行うため、入れるのはPyMySQLだけでよい。しかしFastAPIでDBを処理するときに非同期での操作を行うことを見越し、aiomysqlを入れる。この時点でPyMySQLも入る。
poetry add sqlalchemy alembic aiomysql alembicの初期化 次のコマンドを実行する。
poetry run alembic init alembic プロジェクト配下にalembic/というディレクトリが生成される。
使うDBとの紐づけ alembic.iniを編集する。sqlalchemy.urlの記述を見つけたら以下のようにする。
sqlalchemy.url = mysql&#43;pymysql://&lt;url&gt;/&lt;name&gt;?charset=utf8 &lt;url&gt;と&lt;name&gt;にはそれぞれ、mysqlのサーバーのURLとそのDBの名前を指定する。例えばmysqlがdbというDocker Composeのサービスとして稼働しており、3306ポートで受け付けており、そのDBの名前がappdbだった場合、次のようになる。
sqlalchemy.url = mysql&#43;pymysql://root@db:3306/appdb?charset=utf8 api/db.pyにDBエンティティのベースを作っておく。
from sqlalchemy.ext.declarative import declarative_base Base = declarative_base() alembic/env.pyのtarget_metadataを以下のようにする。
from api.db import Base target_metadata = Base.metadata 空のマイグレーション まだエンティティを作成していない状態でマイグレーションを行ってみる。
マイグレーション用のファイル作成 以下でマイグレーション用のファイルを作成する
poetry run alembic revision --autogenerate -m &#34;empty revision&#34; alembic/versionsにマイグレーション用のファイルが生成されている。"/>


<header>
  
    <a href="https://bombrary.github.io/blog/" class="title">Chanomic Blog</a>
  
  
</header>


<article>
  <header>
    <h1><a href="https://bombrary.github.io/blog/posts/alembic-note/">Alembicを使ったDBマイグレーション（備忘録）</a></h1>
    <div class="meta">
      
      <div class="pub-date">
        <time datetime="2023-06-20T18:38:00&#43;09:00">June 20, 2023</time>
      </div>
      
      
      <div class="lastmod-date">
        <div class="lastmod-date__label">(last modified:</div>
        <time datetime="2023-06-20T18:38:00&#43;09:00">June 25, 2023</time>
        <div class="lastmod-date__label">)</div>
      </div>
      
    </div>
    
    <div class="tags-categories">
      <div class="tags">
        <p>tags: </p>
        <ul class="tags_list">
          <li class="tags_item"><a href="https://bombrary.github.io/blog//tags/alembic/">Alembic</a></li><li class="tags_item"><a href="https://bombrary.github.io/blog//tags/db/">DB</a></li>
        </ul>
        
      </div>
      <div class="categories">
        <p>categories: </p>
        
        <ul class="categories_list">
           <li class="categories_item"><a href="https://bombrary.github.io/blog//categories/python/">Python</a></li>
        </ul>
        
      </div>
    </div>
  </header>
  
  <h2 id="経緯">経緯</h2>
<p>Alembicというライブラリを知ったので、試しに触ってみたメモ。</p>
<h2 id="そもそもalembicとは">そもそもAlembicとは</h2>
<p><a href="https://alembic.sqlalchemy.org/en/latest/index.html">Alembic</a>とは、DBマイグレーションライブラリの1つ。<a href="https://www.sqlalchemy.org/">SQLAlchemy</a>と一緒に用いる。</p>
<h2 id="今回やってみること">今回やってみること</h2>
<p>今回行うマイグレーションは、以下の3つ。</p>
<ol>
<li>空</li>
<li><code>User(email, password)</code>を作成</li>
<li><code>User(email, password, name)</code>に変更</li>
</ol>
<h2 id="使い方">使い方</h2>
<ol>
<li>Alembicの初期化</li>
<li>使うDBとの紐づけ</li>
<li>エンティティ作成</li>
<li>マイグレーションファイルを作成</li>
<li>マイグレーション</li>
</ol>
<h2 id="想定する状況と準備">想定する状況と準備</h2>
<ul>
<li>FastAPI上でWeb APIを提供し、その中でDBを操作することを想定する。ただし、メインテーマがマイグレーションのため、この記事でFastAPIの話は一切出ない。プロジェクト作成について、詳しくは<a href="https://zenn.dev/sh0nk/books/537bb028709ab9">FastAPI入門</a>を参照するとよい。この記事では、ディレクトリ構成を大きく参考にしている。</li>
<li>パッケージ管理には<code>poetry</code>を使う。</li>
<li>DBにはMySQLを使う。</li>
</ul>
<p>マイグレーションは同期処理で行うため、入れるのは<a href="https://pymysql.readthedocs.io/en/latest/">PyMySQL</a>だけでよい。しかしFastAPIでDBを処理するときに非同期での操作を行うことを見越し、<a href="https://aiomysql.readthedocs.io/en/stable/">aiomysql</a>を入れる。この時点でPyMySQLも入る。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry add sqlalchemy alembic aiomysql
</span></span></code></pre></div><h2 id="alembicの初期化">alembicの初期化</h2>
<p>次のコマンドを実行する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic init alembic
</span></span></code></pre></div><p>プロジェクト配下に<code>alembic/</code>というディレクトリが生成される。</p>
<h2 id="使うdbとの紐づけ">使うDBとの紐づけ</h2>
<p><code>alembic.ini</code>を編集する。<code>sqlalchemy.url</code>の記述を見つけたら以下のようにする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">sqlalchemy.url</span> <span class="o">=</span> <span class="s">mysql+pymysql://&lt;url&gt;/&lt;name&gt;?charset=utf8</span>
</span></span></code></pre></div><p><code>&lt;url&gt;</code>と<code>&lt;name&gt;</code>にはそれぞれ、mysqlのサーバーのURLとそのDBの名前を指定する。例えばmysqlが<code>db</code>というDocker Composeのサービスとして稼働しており、3306ポートで受け付けており、そのDBの名前が<code>appdb</code>だった場合、次のようになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">sqlalchemy.url</span> <span class="o">=</span> <span class="s">mysql+pymysql://root@db:3306/appdb?charset=utf8</span>
</span></span></code></pre></div><p><code>api/db.py</code>にDBエンティティのベースを作っておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python3" data-lang="python3"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
</span></span></code></pre></div><p><code>alembic/env.py</code>の<code>target_metadata</code>を以下のようにする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python3" data-lang="python3"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api.db</span> <span class="kn">import</span> <span class="n">Base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target_metadata</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span>
</span></span></code></pre></div><h2 id="空のマイグレーション">空のマイグレーション</h2>
<p>まだエンティティを作成していない状態でマイグレーションを行ってみる。</p>
<h3 id="マイグレーション用のファイル作成">マイグレーション用のファイル作成</h3>
<p>以下でマイグレーション用のファイルを作成する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic revision --autogenerate -m <span class="s2">&#34;empty revision&#34;</span>
</span></span></code></pre></div><p><code>alembic/versions</code>にマイグレーション用のファイルが生成されている。</p>
<h3 id="マイグレーション">マイグレーション</h3>
<p>以下で、<code>alembic/versions</code>に作成されたマイグレーションファイルをもとに、マイグレーションを実行する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic upgrade head
</span></span></code></pre></div><p>これにより、mysqlで新たに<code>alembic_version</code>というテーブルが追加されている。そして新たにレコードが追加されている。</p>
<h2 id="userエンティティ作成">Userエンティティ作成</h2>
<p><code>api/models/user.py</code>を作成する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api.db</span> <span class="kn">import</span> <span class="n">Base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
</span></span></code></pre></div><p><code>alembic/env.py</code>にて以下の記述を追加する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api.models</span> <span class="kn">import</span> <span class="n">user</span>
</span></span></code></pre></div><p>なぜこれをインポートするのかというと、こうしないと<code>Base.metadata</code>の中にUserの情報が入らないから。実際、REPLで確認してみると、<code>api.models.user</code>ないしその<code>Users</code>クラスの宣言が読まれて初めて、<code>Base.metadata.tables</code>の中に情報が入ることが分かる。</p>
<pre tabindex="0"><code>&gt;&gt;&gt; from api.db import Base
&gt;&gt;&gt; Base.metadata.tables
FacadeDict({})
&gt;&gt;&gt; from api.models import user
&gt;&gt;&gt; Base.metadata.tables
FacadeDict({&#39;users&#39;: Table(&#39;users&#39;, MetaData(), Column(&#39;id&#39;, Integer(), table=&lt;users&gt;, primary_key=True, nullable=False), Column(&#39;email&#39;, String(length=256), table=&lt;users&gt;), Column(&#39;password&#39;, String(length=1024), table=&lt;users&gt;), Column(&#39;name&#39;, String(length=1024), table=&lt;users&gt;), schema=None)})
</code></pre><p>これで再びマイグレーションファイルを作成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic revision --autogenerate -m <span class="s2">&#34;create user&#34;</span>
</span></span></code></pre></div><p>次のメッセージが出力されていたら、きちんとUserエンティティが認識され、新たなマイグレーションファイルが作成された証拠である。</p>
<pre tabindex="0"><code>info  [alembic.autogenerate.compare] detected added table &#39;users&#39;
</code></pre><p>生成されたファイルは<code>alembic/versions/&lt;uuid&gt;_create_user.py</code>である。中身を見ると、<code>upgrade</code>関数と<code>downgrade</code>関数の中に諸々の処理が追加されている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
</span></span><span class="line"><span class="cl">    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sa</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### end Alembic commands ###</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">downgrade</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
</span></span><span class="line"><span class="cl">    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### end Alembic commands ###</span>
</span></span></code></pre></div><p>最後にマイグレーションを行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic upgrade head
</span></span></code></pre></div><p>これでmysqlを確認してみると、確かに<code>users</code>テーブルが作成されていることがわかる。</p>
<pre tabindex="0"><code>mysql&gt; show tables;
+-----------------+
| tables_in_demo  |
+-----------------+
| alembic_version |
| users           |
+-----------------+
2 rows in set (0.00 sec)

mysql&gt; describe users;
+----------+---------------+------+-----+---------+----------------+
| field    | type          | null | key | default | extra          |
+----------+---------------+------+-----+---------+----------------+
| id       | int           | no   | pri | null    | auto_increment |
| email    | varchar(256)  | yes  | uni | null    |                |
| password | varchar(1024) | yes  |     | null    |                |
+----------+---------------+------+-----+---------+----------------+
3 rows in set (0.01 sec)
</code></pre><h2 id="userエンティティの変更">Userエンティティの変更</h2>
<p>例えばUserエンティティに新たな属性<code>name</code>を追加する。<code>api/models/user.py</code>に追記する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api.db</span> <span class="kn">import</span> <span class="n">Base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
</span></span></code></pre></div><p>マイグレーションファイルを作成する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic revision --autogenerate -m <span class="s2">&#34;modify user&#34;</span>
</span></span></code></pre></div><p>以下のメッセージが出力されたら、<code>users</code>テーブルに<code>name</code>カラムが追加されることをAlembicが認識した証拠である。</p>
<pre tabindex="0"><code>info  [alembic.autogenerate.compare] detected added column &#39;users.name&#39;
</code></pre><p><code>alembic/versions/&lt;uuid&gt;_modify_user.py</code>を見てみると、実際にカラムを追加する処理が走っていることがわかる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
</span></span><span class="line"><span class="cl">    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### end Alembic commands ###</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">downgrade</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
</span></span><span class="line"><span class="cl">    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ### end Alembic commands ###</span>
</span></span></code></pre></div><p>以下でマイグレーションの実行を行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">poetry run alembic upgrade head
</span></span></code></pre></div><p>mysqlで見てみると、<code>name</code>の項目が追加されていることが分かる。</p>
<pre tabindex="0"><code>mysql&gt; describe users;
+----------+---------------+------+-----+---------+----------------+
| field    | type          | null | key | default | extra          |
+----------+---------------+------+-----+---------+----------------+
| id       | int           | no   | pri | null    | auto_increment |
| email    | varchar(256)  | yes  | uni | null    |                |
| password | varchar(1024) | yes  |     | null    |                |
| name     | varchar(1024) | yes  |     | null    |                |
+----------+---------------+------+-----+---------+----------------+
4 rows in set (0.00 sec)
</code></pre>
</article>



</html>
